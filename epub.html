<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>epub read</title>

    <style>
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 20%;
            height: 98vh;
            overflow-y: scroll;
            padding-bottom: 10em;
        }

        iframe {
            width: 79%;
            float: right;
            height: 98vh;
        }

        nav a {
            display: block;
            text-decoration: none;
            color: #000;
        }

        nav ul {
            padding-left: 1em;
        }

        #fDiv {
            position: fixed;
            bottom: 0;
            right: 81%;
            padding: 0.5em;
            margin: 0.5em;
            background: rgba(192, 192, 192, 0.3);

        }

        #fDiv div {
            margin: 0.5em auto;
            font-size: large;
            cursor: pointer;
        }

        .unicode {
            font-size: xx-large;
        }
    </style>

    <script>

        let windowsUrl = new URL(window.location.href);;//å½“å‰è·¯å¾„url
        //è·å–å½“å‰åœ°å€çˆ¶è·¯å¾„ /code/local/local-docs
        let basePath = location.pathname.substring(0, location.pathname.lastIndexOf("/"));
        let context = window.origin + basePath + "/";// "http://localhost/code/local/local-docs"

        //[ä½¿ç”¨ EPUB åˆ¶ä½œæ•°å­—å›¾ä¹¦](https://www.ibm.com/developerworks/cn/xml/tutorials/x-epubtut/index.html)
        let path;//epubæ–‡ä»¶å¤¹è·¯å¾„ 
        let contentOpf, tocNcx;//  content.opf   toc.ncx ç”µå­ä¹¦å…ƒæ•°æ®

        const domParser = new DOMParser();//æ–‡æ¡£è§£æå™¨

        let navA = [];//å½“å‰å¯¼èˆªæ æ‰€æœ‰è¶…é“¾æ¥

        const load = async () => {

            path = windowsUrl.searchParams.get("path") || "jboss/red_hat_jboss/7.2/getting_started_guide";//é»˜è®¤è·¯å¾„ æµ‹è¯•ç”¨
            path += path.endsWith("/") ? "" : "/";//å¦‚æœæ²¡æœ‰ æ–œæ ç»“å°¾ è¡¥å…¨æ–œæ 

            contentOpf = await fetch(path + "content.opf").then(response => response.status == 200 ? response.text() : '');
            tocNcx = await fetch(path + "toc.ncx").then(response => response.status == 200 ? response.text() : '');

            contentOpf || console.log("content.opf is empty");
            tocNcx || console.log("toc.ncx is empty");

            if (contentOpf) {
                contentOpf = domParser.parseFromString(contentOpf, "application/xml");
                let metadata = contentOpf.querySelector("metadata");
                //[11. Accessing Page Elements - JavaScript Cookbook [Book]](https://www.oreilly.com/library/view/javascript-cookbook/9781449390211/ch11.html) 
                //ä½¿ç”¨ contentOpf.querySelector('[dc\\:title]') æ— æ•ˆ
                //ä½¿ç”¨ getElementsByTagName è·å–å…ƒç´  
                let tags, innerHTML;
                innerHTML = "";
                if ((tags = metadata.getElementsByTagName('dc:date')).length > 0) {
                    innerHTML += tags[0].textContent + " ";
                }
                if ((tags = metadata.getElementsByTagName('dc:title')).length > 0) {
                    innerHTML += tags[0].textContent + " ";
                }
                document.getElementById("metadataS").innerHTML = innerHTML;
                if ((tags = metadata.getElementsByTagName('dc:description')).length > 0) {
                    document.getElementById("metadataP").innerHTML += tags[0].textContent + " ";
                }

            }

            //ä¸ä¸ºç©º æ¸²æŸ“é¡µé¢
            if (tocNcx) {
                let tocText = "";
                // txtæ–‡æœ¬è½¬æ¢ä¸º dom ç»“æ„
                tocNcx = domParser.parseFromString(tocNcx, "application/xml");
                document.getElementById("toc").innerHTML = navPoint2Html(tocNcx.querySelectorAll("navMap>navPoint"));
            }
            navA = [...document.querySelectorAll("nav a")];

            console.log("window.location.hash" + window.location.hash);
            if (window.location.hash && window.location.hash.length > 0) {
                document.getElementById('contentF').src = window.location.hash.substring(1);
            }



            // let hash = window.location.hash;
            // if (hash) {
            //     let contentF = document.getElementById('contentF');
            //     console.log("load to contentF:" + context + hash.substring(1));
            //     contentF.contentWindow.document.location.href = context + hash.substring(1);
            // }
        }
        window.onload = load;//åˆå§‹åŒ–


        /***
        <navPoint id="idm140147838654208" playOrder="1">
            <navLabel><text>Getting Started Guide</text></navLabel>
            <content src="index.html"/>
            <navPoint id="idm140147837239616" playOrder="2">
            </navPoint>
        **/
        //navPoint èŠ‚ç‚¹è½¬æ¢ä¸ºhtml
        function navPoint2Html(navPoints) {
            let navPointHTML = "";
            navPoints.forEach((navPoint) => {// onclick="window.location.hash = this.getAttribute('href');
                navPointHTML += "<li>";
                navPointHTML += `<a  target="contentF" " 
                                     href="${path}${navPoint.querySelector(":scope>content").getAttribute("src")}">
                                  ${navPoint.querySelector(":scope>navLabel>text").textContent}
                                </a>`;
                //è·å–å­å…ƒç´ 
                let subnavPoints = navPoint.querySelectorAll(":scope>navPoint");
                if (subnavPoints.length > 0) {
                    navPointHTML += `<ul>${navPoint2Html(subnavPoints)}</ul>`;
                }
                navPointHTML += "</li>";
            });
            return navPointHTML;
        }

        //iframe å†…å®¹å˜åŒ–æˆ–è€…æ›´æ–°æ—¶
        function contentFChange() {
            let contentF = document.getElementById('contentF');
            let contentHref = contentF.contentWindow.document.location.href;
            //ä¸€å¼€å§‹ä¼šé»˜è®¤è¿›å…¥  about:blank
            if (contentHref != 'about:blank') {
                document.title = contentF.contentWindow.document.title;
                contentF.contentWindow.onhashchange = contentFChange;
                console.log("contentF change:" + contentF.contentWindow.document.location.href);
                window.location.hash = contentF.contentWindow.document.location.href.replace(context, "");

                updateBookmark();
            }
        }

        //æ›´æ–°ä¹¦ç­¾æ‰€åœ¨ä½ç½®
        function updateBookmark() {
            let cHref = window.location.hash.substr(1);//å½“å‰é“¾æ¥
            let cIndex = navA.findIndex(a => a.getAttribute('href')
                && a.getAttribute('href').endsWith(cHref));//hrefæœ‰å€¼ å¹¶ä¸”æœ‰å½“å‰åœ°å€çš„åç¼€ å¹¶ä¸” å½“å‰ aä¸ºç©º æˆ–è€… å½“å‰ä¸æ˜¯æ­¤
            if (navA[cIndex]) {
                //åœ¨å¯è§†çª—å£çš„ä¸Šé¢æˆ–è€…ä¸‹é¢æ—¶å€™æ»šåŠ¨
                if (navA[cIndex].getBoundingClientRect().top < 0
                    || navA[cIndex].getBoundingClientRect().bottom > document.documentElement.clientHeight) {
                    navA[cIndex].scrollIntoView();
                }
                //ä¹¦ç­¾ç´§è·Ÿèœå•æ ‡ç­¾
                bookmark.style.top = navA[cIndex].getBoundingClientRect().top + "px";
            }
        }

        function goPage(offset) {
            let contentF = document.getElementById('contentF');
            if (window.location.hash && window.location.hash.length > 0) {
                let cHref = window.location.hash.substr(1);//å½“å‰é“¾æ¥
                let cIndex = navA.findIndex(a => a.getAttribute('href')
                    && a.getAttribute('href').endsWith(cHref));
                cIndex = cIndex + offset;
                if (cIndex < 0) {
                    cIndex = 0;//æœ€å°æ˜¯å¤´
                    console.log("è¶…è¿‡æœ€å° è®¾ç½®ä¸º0");
                } else if (cIndex >= navA.length) {
                    cIndex = navA.length - 1;//æœ€å¤§æ˜¯å°¾
                    console.log("è¶…è¿‡æœ€æœ«è®¾ç½®ä¸ºæœ€æœ«");
                }

                contentF.src = navA[cIndex].getAttribute('href');
            }
        }

        //å¤šè¯­è¨€æ²¡æœ‰ç»Ÿä¸€è®¾ç½®è¿™é‡Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ¤æ–­
        function goBook() {

            const epubConfig = {
                translationPath: [
                    ['(redhat/8)(/)(.*)', '$1.zh-Hans$2$3'],
                    ['(redhat/8)(\\.zh-Hans)(/)(.*)', "$1$3$4"]
                ]
            };

            let newPath = '';
            for (let i = 0; i < epubConfig.translationPath.length; i++) {
                // var newstr = "John Smith".replace(/(\w+)\s(\w+)/, "$2, $1");// "Smith, John"
                let regExp = new RegExp(epubConfig.translationPath[i][0]);
                let substr = epubConfig.translationPath[i][1];
                let replaceStr = path.replace(regExp, substr);

                console.log("regExp:" + regExp);
                console.log("substr:" + substr);
                console.log("replaceStr:" + replaceStr);

                if (path != replaceStr) {//è¯´æ˜æ›¿æ¢æˆåŠŸ
                    newPath = replaceStr;
                    break;
                }
            }
            if (newPath != '' && newPath != path) {
                window.open(window.location.href.replace(path, newPath));
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°å…¶ä»–ç‰ˆæœ¬');
            }
        }

        //ç›®å½•æ˜¾ç¤ºæ§åˆ¶
        function displayToc() {
            if (navigation.style.display == '') {
                navigation.style.display = 'none';//éšè—
                document.getElementById('contentF').style.width = "100%";
                fDiv.style.right = '0%';//éšè—
            } else {
                navigation.style.display = '';//è¿˜åŸ
                document.getElementById('contentF').style.width = "79%";

                fDiv.style.right = '81%';//è¿˜åŸ  
            }
        }

    </script>

</head>

<body>

    <!-- å¯¼èˆªæ  -->
    <nav id="navigation">
        <!-- æ›¸ç°½ -->
        <span id="bookmark" style="position: fixed;">ğŸ”–</span>
        <h1>metadata</h1>
        <details>
            <summary id="metadataS"></summary>
            <p id="metadataP"></p>
        </details>
        <h1> Table of contents </h1>
        <ul id="toc">
        </ul>
    </nav>

    <!-- åŠŸèƒ½åŒºåŸŸ -->
    <div id="fDiv">

        <div onclick="displayToc()" title="æŠ˜å /å±•å¼€ç›®å½•">æŠ˜å <span class="unicode">â¬·</span> </div>
        <!-- onclick="tocfragmentTFlag && window.open(`${tocfragmentTURL}${window.location.hash}`);" -->
        <div onclick="goBook()" title="æ‰“å¼€ EN/ä¸­æ–‡"> ä¸­è‹±<span class="unicode">â‡„</span></div>
        <div onclick="goPage(-1)" title="è·³è½¬ä¸Šä¸€é¡µ">ä¸Šé¡µ <span class="unicode">â—</span></div>
        <div onclick="goPage(1)" title="è·³è½¬ä¸‹ä¸€é¡µ">ä¸‹é¡µ <span class="unicode">â˜</span></div>

    </div>

    <!--å†…å®¹é¡µ-->
    <iframe frameborder=0 id="contentF" name="contentF" onload="contentFChange()">

    </iframe>


</body>

</html>