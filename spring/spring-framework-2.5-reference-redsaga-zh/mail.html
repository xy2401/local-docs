<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;22.&nbsp;Spring&#37038;&#20214;&#25277;&#35937;&#23618;</title><link rel="stylesheet" href="html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.60.1"><link rel="home" href="index.html" title="Spring Framework &#24320;&#21457;&#21442;&#32771;&#25163;&#20876;"><link rel="up" href="spring-integration.html" title="Part&nbsp;IV.&nbsp;&#25972;&#21512;"><link rel="previous" href="cci.html" title="Chapter&nbsp;21.&nbsp;JCA CCI"><link rel="next" href="scheduling.html" title="Chapter&nbsp;23.&nbsp;Spring&#20013;&#30340;&#23450;&#26102;&#35843;&#24230;(Scheduling)&#21644;&#32447;&#31243;&#27744;(Thread Pooling)"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://www.springframework.org/" title="The Spring Framework"><img style="border:none;" src="images/xdev-spring_logo.jpg"></a><a style="border:none;" href="http://www.springsource.com/" title="SpringSource"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/springsource-banner-rhs.png"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="mail"></a>Chapter&nbsp;22.&nbsp;Spring&#37038;&#20214;&#25277;&#35937;&#23618;</h2></div></div><div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-introduction"></a>22.1.&nbsp;&#31616;&#20171;</h2></div></div><div></div></div><div class="sidebar"><p class="title"><b>&#36164;&#28304;&#31867;&#24211;&#20381;&#36182;</b></p><p>&#19979;&#38754;&#25152;&#21015;&#20986;&#30340;jar&#25991;&#20214;&#24517;&#39035;&#21152;&#21040;&#20320;&#24212;&#29992;&#31243;&#24207;&#30340;classpath&#20013;&#65292;&#22240;&#20026;&#36825;&#20123;&#37117;&#26159;Spring Framework&#37038;&#20214;&#25277;&#35937;&#23618;&#25152;&#20381;&#36182;&#30340;&#24211;&#25991;&#20214;&#12290;</p><div class="itemizedlist"><ul type="disc"><li><p><a href="http://java.sun.com/products/javamail/" target="_top">JavaMail</a> <tt class="filename">mail.jar</tt>&#24211;</p></li><li><p><a href="http://java.sun.com/products/javabeans/jaf/downloads/index.html" target="_top">JAF</a> <tt class="filename">activation.jar</tt>&#24211;</p></li></ul></div><p>&#25152;&#26377;&#36825;&#20123;&#20381;&#36182;&#30340;&#24211;&#37117;&#21487;&#20197;&#22312;Spring Framework&#30340;Spring-with-dependencies&#30340;release&#21253;&#20013;&#33719;&#24471; (&#21516;&#26102;&#20063;&#21487;&#20197;&#22312;&#32593;&#19978;&#20813;&#36153;&#33719;&#24471;)&#12290;</p></div><p>Spring&#25552;&#20379;&#20102;&#19968;&#20010;&#21457;&#36865;&#30005;&#23376;&#37038;&#20214;&#30340;&#39640;&#32423;&#25277;&#35937;&#23618;&#65292;&#23427;&#21521;&#29992;&#25143;&#23631;&#34109;&#20102;&#24213;&#23618;&#37038;&#20214;&#31995;&#32479;&#30340;&#19968;&#20123;&#32454;&#33410;&#65292;&#21516;&#26102;&#20195;&#34920;&#23458;&#25143;&#31471;&#36127;&#36131;&#24213;&#23618;&#30340;&#36164;&#28304;&#22788;&#29702;&#12290;</p><p>Spring&#37038;&#20214;&#25277;&#35937;&#23618;&#30340;&#20027;&#35201;&#21253;&#20026;<tt class="literal">org.springframework.mail</tt>&#12290;&#23427;&#21253;&#25324;&#20102;&#21457;&#36865;&#30005;&#23376;&#37038;&#20214;&#30340;&#20027;&#35201;&#25509;&#21475;<tt class="interfacename">MailSender</tt>&#65292;&#21644;<span class="emphasis"><em>&#20540;&#23545;&#35937;</em></span><tt class="classname">SimpleMailMessage</tt>&#65292;&#23427;&#23553;&#35013;&#20102;&#31616;&#21333;&#37038;&#20214;&#30340;&#23646;&#24615;&#22914;<span class="emphasis"><em>from</em></span>, <span class="emphasis"><em>to</em></span>,<span class="emphasis"><em>cc</em></span>, <span class="emphasis"><em>subject</em></span>,<span class="emphasis"><em>text</em></span>&#12290;
	&#21253;&#37324;&#36824;&#21253;&#21547;&#19968;&#26869;&#20197;<tt class="classname">MailException</tt>&#20026;&#26681;&#30340;checked Exception&#32487;&#25215;&#26641;&#65292;&#23427;&#20204;&#25552;&#20379;&#20102;&#23545;&#24213;&#23618;&#37038;&#20214;&#31995;&#32479;&#24322;&#24120;&#30340;&#39640;&#32423;&#21035;&#25277;&#35937;&#12290; &#35201;&#33719;&#24471;&#20851;&#20110;&#37038;&#20214;&#24322;&#24120;&#23618;&#27425;&#30340;&#26356;&#20016;&#23500;&#30340;&#20449;&#24687;&#65292;&#35831;&#21442;&#32771;Javadocs&#12290;</p><p>&#20026;&#20102;&#20351;&#29992;<span class="emphasis"><em>JavaMail</em></span>&#20013;&#30340;&#19968;&#20123;&#29305;&#33394;, &#27604;&#22914;MIME&#31867;&#22411;&#30340;&#20449;&#20214;, Spring&#25552;&#20379;&#20102;<tt class="interfacename">MailSender</tt>&#30340;&#19968;&#20010;&#23376;&#25509;&#21475;,	&#21363;<tt class="classname">org.springframework.mail.javamail.JavaMailSender</tt>&#12290;
		Spring&#36824;&#25552;&#20379;&#20102;&#19968;&#20010;&#22238;&#35843;&#25509;&#21475;<tt class="interfacename">org.springframework.mail.javamail.MimeMessagePreparator</tt>, &#29992;&#20110;&#20934;&#22791;JavaMail&#30340;MIME&#20449;&#20214;&#12290;</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-usage"></a>22.2.&nbsp;&#20351;&#29992;Spring&#37038;&#20214;&#25277;&#35937;</h2></div></div><div></div></div><p>&#20551;&#35774;&#26576;&#20010;&#19994;&#21153;&#25509;&#21475;&#21517;&#20026;<tt class="interfacename">OrderManager</tt>:</p><pre class="programlisting">public interface OrderManager {

    void placeOrder(Order order);
}</pre><p>&#25105;&#20204;&#21516;&#26102;&#20551;&#35774;&#26377;&#19968;&#20010;&#29992;&#20363;&#65306;&#38656;&#35201;&#29983;&#25104;&#24102;&#26377;&#35746;&#21333;&#21495;&#30340;email&#20449;&#20214;, &#24182;&#21521;&#23458;&#25143;&#21457;&#36865;&#35813;&#35746;&#21333;&#12290;</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="mail-usage-simple"></a>22.2.1.&nbsp;<tt class="interfacename">MailSender</tt> &#21644; <tt class="classname">SimpleMailMessage</tt> &#30340;&#22522;&#26412;&#29992;&#27861;</h3></div></div><div></div></div><pre class="programlisting">import org.springframework.mail.MailException;
import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;

public class SimpleOrderManager implements OrderManager {

    private MailSender mailSender;
    private SimpleMailMessage templateMessage;

    public void setMailSender(MailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void setTemplateMessage(SimpleMailMessage templateMessage) {
        this.templateMessage = templateMessage;
    }

    public void placeOrder(Order order) {

        <i class="lineannotation"><span class="lineannotation">// Do the business calculations...</span></i>

        <i class="lineannotation"><span class="lineannotation">// Call the collaborators to persist the order...</span></i>

        <i class="lineannotation"><span class="lineannotation">// Create a thread safe "copy" of the template message and customize it</span></i>
        SimpleMailMessage msg = new SimpleMailMessage(this.templateMessage);
        msg.setTo(order.getCustomer().getEmailAddress());
        msg.setText(
            "Dear " + order.getCustomer().getFirstName()
                + order.getCustomer().getLastName()
                + ", thank you for placing order. Your order number is "
                + order.getOrderNumber());
        try{
            this.mailSender.send(msg);
        }
        catch(MailException ex) {
            <i class="lineannotation"><span class="lineannotation">// simply log it and go on...</span></i>
            System.err.println(ex.getMessage());            
        }
    }
}</pre><p>&#19978;&#38754;&#30340;&#20195;&#30721;&#30340;bean&#23450;&#20041;&#24212;&#35813;&#26159;&#36825;&#26679;&#30340;:</p><pre class="programlisting">&lt;bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"&gt;
  &lt;property name="host" value="mail.mycompany.com"/&gt;
&lt;/bean&gt;

<i class="lineannotation"><span class="lineannotation">&lt;!-- this is a template message that we can pre-load with default state --&gt;</span></i>
&lt;bean id="templateMessage" class="org.springframework.mail.SimpleMailMessage"&gt;
  &lt;property name="from" value="customerservice@mycompany.com"/&gt;
  &lt;property name="subject" value="Your order"/&gt;
&lt;/bean&gt;

&lt;bean id="orderManager" class="com.mycompany.businessapp.support.SimpleOrderManager"&gt;
  &lt;property name="mailSender" ref="mailSender"/&gt;
  &lt;property name="templateMessage" ref="templateMessage"/&gt;
&lt;/bean&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="mail-usage-mime"></a>22.2.2.&nbsp;&#20351;&#29992; <tt class="interfacename">JavaMailSender</tt> &#21644; <tt class="classname">MimeMessagePreparator</tt></h3></div></div><div></div></div><p>&#19979;&#38754;&#26159;<tt class="interfacename">OrderManager</tt>&#30340;&#21478;&#19968;&#31181;&#23454;&#29616;, &#20351;&#29992;&#20102;<tt class="interfacename">MimeMessagePreparator</tt>&#22238;&#35843;&#25509;&#21475;&#12290;
			 &#35831;&#27880;&#24847;&#22312;&#36825;&#20010;&#29992;&#20363;&#20013;&#65292;<tt class="literal">mailSender</tt>&#23646;&#24615;&#26159;<tt class="interfacename">JavaMailSender</tt>&#31867;&#22411;&#65292; &#25152;&#20197;&#25105;&#20204;&#21487;&#20197;&#20351;&#29992;JavaMail&#30340;<tt class="classname">MimeMessage</tt>&#31867;&#65306;</p><pre class="programlisting">import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;

import javax.mail.internet.MimeMessage;
import org.springframework.mail.MailException;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessagePreparator;

public class SimpleOrderManager implements OrderManager {

    private JavaMailSender mailSender;
    
    public void setMailSender(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void placeOrder(final Order order) {

        <i class="lineannotation"><span class="lineannotation">// Do the business calculations...</span></i>

        <i class="lineannotation"><span class="lineannotation">// Call the collaborators to persist the order...</span></i>
        
        MimeMessagePreparator preparator = new MimeMessagePreparator() {
        
            public void prepare(MimeMessage mimeMessage) throws Exception {
        
                mimeMessage.setRecipient(Message.RecipientType.TO, 
                        new InternetAddress(order.getCustomer().getEmailAddress()));
                mimeMessage.setFrom(new InternetAddress("mail@mycompany.com"));
                mimeMessage.setText(
                    "Dear " + order.getCustomer().getFirstName() + " "
                        + order.getCustomer().getLastName()
                        + ", thank you for placing order. Your order number is "
                        + order.getOrderNumber());
            }
        };
        try {
            this.mailSender.send(preparator);
        }
        catch (MailException ex) {
            <i class="lineannotation"><span class="lineannotation">// simply log it and go on...</span></i>
            System.err.println(ex.getMessage());            
        }
    }
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="http://shouce.jb51.net/images/admons/note.png"></td><th align="left">Note</th></tr><tr><td colspan="2" align="left" valign="top"><p>&#20197;&#19978;&#30340;&#37038;&#20214;&#20195;&#30721;&#26159;&#19968;&#20010;&#27178;&#20999;&#20851;&#27880;&#28857;&#65292;&#33021;&#34987;&#23436;&#32654;&#22320;&#37325;&#26500;&#20026;<a href="aop.html" title="Chapter&nbsp;6.&nbsp;&#20351;&#29992;Spring&#36827;&#34892;&#38754;&#21521;&#20999;&#38754;&#32534;&#31243;&#65288;AOP&#65289;">&#33258;&#23450;&#20041;Spring AOP&#20999;&#38754;</a>&#30340;&#20505;&#36873;&#32773;&#65292;&#36825;&#26679;&#23427;&#23601;&#21487;&#20197;&#22312;&#30446;&#26631;&#23545;&#35937;<tt class="interfacename">OrderManager</tt>&#30340;&#19968;&#20123;&#21512;&#36866;&#30340;&#36830;&#25509;&#28857;&#65288;joinpoint&#65289;&#20013;&#34987;&#25191;&#34892;&#20102;&#12290;</p></td></tr></table></div><p>Spring Framework&#30340;&#37038;&#20214;&#25903;&#25345;&#30452;&#25509;&#25552;&#20379;&#20004;&#31181;<tt class="interfacename">MailSender</tt>&#30340;&#23454;&#29616;&#12290;&#26631;&#20934;&#30340;JavaMail&#23454;&#29616;&#21644;&#22522;&#20110;Jason Hunter&#32534;&#20889;&#30340;<tt class="classname">MailMessage</tt>&#31867;&#20043;&#19978;&#30340;&#23454;&#29616;&#65292;&#21518;&#32773;&#20301;&#20110;<a href="http://servlets.com/cos" target="_top"><tt class="literal">com.oreilly.servlet</tt>&#21253;</a>&#20013;&#12290;&#35831;&#26597;&#38405;&#30456;&#20851;Javadocs&#20197;&#33719;&#24471;&#36827;&#19968;&#27493;&#30340;&#36164;&#26009;&#12290;</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-javamail-mime"></a>22.3.&nbsp;&#20351;&#29992;<tt class="classname">MimeMessageHelper</tt></h2></div></div><div></div></div><p>
  		<tt class="classname">org.springframework.mail.javamail.MimeMessageHelper</tt>&#26159;&#22788;&#29702;JavaMail&#37038;&#20214;&#26102;&#27604;&#36739;&#39034;&#25163;&#32452;&#20214;&#20043;&#19968;&#12290;&#23427;&#21487;&#20197;&#35753;&#20320;&#25670;&#33073;&#32321;&#22797;&#30340;JavaMail API&#12290;
  		&#36890;&#36807;&#20351;&#29992;<tt class="classname">MimeMessageHelper</tt>&#65292;&#21019;&#24314;&#19968;&#20010;<tt class="classname">MimeMessage</tt>&#23454;&#20363;&#23558;&#38750;&#24120;&#23481;&#26131;&#65306;
  	</p><pre class="programlisting"><i class="lineannotation"><span class="lineannotation">// of course you would use DI in any real-world cases</span></i>
JavaMailSenderImpl sender = new JavaMailSenderImpl();
sender.setHost("mail.host.com");

MimeMessage message = sender.createMimeMessage();
MimeMessageHelper helper = new MimeMessageHelper(message);
helper.setTo("test@host.com");
helper.setText("Thank you for ordering!");

sender.send(message);</pre><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="mail-javamail-mime-attachments"></a>22.3.1.&nbsp;&#21457;&#36865;&#38468;&#20214;&#21644;&#23884;&#20837;&#24335;&#36164;&#28304;(inline resources)</h3></div></div><div></div></div><p>Multipart email&#20801;&#35768;&#28155;&#21152;&#38468;&#20214;&#21644;&#20869;&#23884;&#36164;&#28304;(inline resources)&#12290;&#20869;&#23884;&#36164;&#28304;&#21487;&#33021;&#26159;&#20320;&#22312;&#20449;&#20214;&#20013;&#24076;&#26395;&#20351;&#29992;&#30340;&#22270;&#20687;&#25110;&#26679;&#24335;&#34920;&#65292;&#20294;&#26159;&#21448;&#19981;&#24819;&#25226;&#23427;&#20204;&#20316;&#20026;&#38468;&#20214;&#12290;</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="mail-javamail-mime-attachments-attachment"></a>22.3.1.1.&nbsp;&#38468;&#20214;</h4></div></div><div></div></div><p>&#19979;&#38754;&#30340;&#20363;&#23376;&#23558;&#23637;&#31034;&#22914;&#20309;&#20351;&#29992;<tt class="classname">MimeMessageHelper</tt>&#26469;&#21457;&#36865;&#19968;&#23553;email&#65292;&#20351;&#29992;&#19968;&#20010;&#31616;&#21333;&#30340;JPEG&#22270;&#29255;&#20316;&#20026;&#38468;&#20214;&#65306;</p><pre class="programlisting">JavaMailSenderImpl sender = new JavaMailSenderImpl();
sender.setHost("mail.host.com");

MimeMessage message = sender.createMimeMessage();

<i class="lineannotation"><span class="lineannotation">// use the true flag to indicate you need a multipart message</span></i>
MimeMessageHelper helper = new MimeMessageHelper(message, true);
helper.setTo("test@host.com");

helper.setText("Check out this image!");

<i class="lineannotation"><span class="lineannotation">// let's attach the infamous windows Sample file (this time copied to c:/)</span></i>
FileSystemResource file = new FileSystemResource(new File("c:/Sample.jpg"));
helper.addAttachment("CoolImage.jpg", file);

sender.send(message);</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="mail-javamail-mime-attachments-inline"></a>22.3.1.2.&nbsp;&#20869;&#23884;&#36164;&#28304;</h4></div></div><div></div></div><p>&#19979;&#38754;&#30340;&#20363;&#23376;&#23558;&#23637;&#31034;&#22914;&#20309;&#20351;&#29992;<tt class="classname">MimeMessageHelper</tt>&#26469;&#21457;&#36865;&#19968;&#23553;&#21547;&#26377;&#20869;&#23884;&#36164;&#28304;&#30340;email&#65306;</p><pre class="programlisting">JavaMailSenderImpl sender = new JavaMailSenderImpl();
sender.setHost("mail.host.com");

MimeMessage message = sender.createMimeMessage();

<i class="lineannotation"><span class="lineannotation">// use the true flag to indicate you need a multipart message</span></i>
MimeMessageHelper helper = new MimeMessageHelper(message, true);
helper.setTo("test@host.com");

<i class="lineannotation"><span class="lineannotation">// use the true flag to indicate the text included is HTML</span></i>
helper.setText("&lt;html&gt;&lt;body&gt;&lt;img src='cid:identifier1234'&gt;&lt;/body&gt;&lt;/html&gt;", true);

<i class="lineannotation"><span class="lineannotation">// let's include the infamous windows Sample file (this time copied to c:/)</span></i>
FileSystemResource res = new FileSystemResource(new File("c:/Sample.jpg"));
helper.addInline("identifier1234", res);

sender.send(message);</pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="http://shouce.jb51.net/images/admons/warning.png"></td><th align="left">Warning</th></tr><tr><td colspan="2" align="left" valign="top"><p>&#22914;&#20320;&#25152;&#35265;&#65292;&#23884;&#20837;&#24335;&#36164;&#28304;&#20351;&#29992;<tt class="literal">Content-ID</tt>(&#19978;&#20363;&#20013;&#26159;<tt class="literal">identifier1234</tt>)&#26469;&#25554;&#20837;&#21040;mime&#20449;&#20214;&#20013;&#21435;&#12290;&#20320;&#21152;&#20837;&#25991;&#26412;&#21644;&#36164;&#28304;&#30340;&#39034;&#24207;&#26159;<span class="bold"><b>&#38750;&#24120;</b></span>&#37325;&#35201;&#30340;&#12290;&#39318;&#20808;&#65292;&#20320;&#21152;&#20837;&#25991;&#26412;&#65292;&#38543;&#21518;&#26159;&#36164;&#28304;&#12290;&#22914;&#26524;&#39034;&#24207;&#24324;&#21453;&#20102;&#65292;&#23427;&#23558;&#26080;&#27861;&#27491;&#24120;&#36816;&#20316;&#65281;</p></td></tr></table></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="mail-templates"></a>22.3.2.&nbsp;&#20351;&#29992;&#27169;&#26495;&#26469;&#21019;&#24314;&#37038;&#20214;&#20869;&#23481;</h3></div></div><div></div></div><p>&#22312;&#20043;&#21069;&#30340;&#20195;&#30721;&#31034;&#20363;&#20013;&#65292;&#25152;&#26377;&#37038;&#20214;&#30340;&#20869;&#23481;&#37117;&#26159;&#26174;&#24335;&#23450;&#20041;&#30340;&#65292;&#24182;&#36890;&#36807;&#35843;&#29992;<tt class="methodname">message.setText(..)</tt>&#26469;&#35774;&#32622;&#37038;&#20214;&#20869;&#23481;&#12290; 
			&#36825;&#31181;&#20570;&#27861;&#38024;&#23545;&#31616;&#21333;&#30340;&#24773;&#20917;&#25110;&#22312;&#19978;&#36848;&#30340;&#20363;&#23376;&#20013;&#27809;&#20160;&#20040;&#38382;&#39064;&#65292;&#22240;&#20026;&#22312;&#36825;&#37324;&#21482;&#26159;&#20026;&#20102;&#21521;&#20320;&#23637;&#31034;&#22522;&#30784;API&#12290;</p><p>&#32780;&#22312;&#20320;&#33258;&#24049;&#30340;&#20225;&#19994;&#32423;&#24212;&#29992;&#31243;&#24207;&#20013;, &#22522;&#20110;&#22914;&#19979;&#30340;&#21407;&#22240;&#65292;&#20320;&#19981;&#20250;&#20197;&#19978;&#36848;&#26041;&#24335;&#21019;&#24314;&#20320;&#30340;&#37038;&#20214;&#20869;&#23481;&#65306;</p><p>
				</p><div class="itemizedlist"><ul type="disc"><li><p>&#20351;&#29992;Java&#20195;&#30721;&#26469;&#21019;&#24314;&#22522;&#20110;HTML&#30340;&#37038;&#20214;&#20869;&#23481;&#19981;&#20165;&#23481;&#26131;&#29359;&#38169;&#65292;&#21516;&#26102;&#20063;&#26159;&#19968;&#20214;&#21333;&#35843;&#20047;&#21619;&#30340;&#20107;&#24773;</p></li><li><p>&#36825;&#26679;&#20570;&#65292;&#20320;&#23558;&#26080;&#27861;&#23558;&#26174;&#31034;&#36923;&#36753;&#21644;&#19994;&#21153;&#36923;&#36753;&#24456;&#26126;&#30830;&#30340;&#21306;&#20998;&#24320;</p></li><li><p>&#19968;&#26086;&#38656;&#35201;&#20462;&#25913;&#37038;&#20214;&#20869;&#23481;&#30340;&#26174;&#24335;&#26684;&#24335;&#21644;&#20869;&#23481;&#65292;&#20320;&#38656;&#35201;&#37325;&#26032;&#32534;&#20889;Java&#20195;&#30721;&#65292;&#37325;&#26032;&#32534;&#35793;&#65292;&#37325;&#26032;&#37096;&#32626;&#8230;&#8230;</p></li></ul></div><p>
			</p><p>&#19968;&#33324;&#26469;&#35828;&#35299;&#20915;&#36825;&#20123;&#38382;&#39064;&#30340;&#20856;&#22411;&#30340;&#26041;&#24335;&#26159;&#20351;&#29992;FreeMarker&#25110;&#32773;Velocity&#36825;&#26679;&#30340;&#27169;&#26495;&#35821;&#35328;&#26469;&#23450;&#20041;&#37038;&#20214;&#20869;&#23481;&#30340;&#26174;&#24335;&#32467;&#26500;&#12290;
			&#36825;&#26679;&#65292;&#20320;&#30340;&#20219;&#21153;&#23601;&#26159;&#22312;&#20320;&#30340;&#20195;&#30721;&#20013;&#65292;&#21482;&#35201;&#21019;&#24314;&#22312;&#37038;&#20214;&#27169;&#26495;&#20013;&#38656;&#35201;&#23637;&#31034;&#30340;&#25968;&#25454;&#65292;&#24182;&#21457;&#36865;&#37038;&#20214;&#21363;&#21487;&#12290;&#36890;&#36807;&#20351;&#29992;Spring&#23545;FreeMarker&#21644;Velocity&#30340;&#25903;&#25345;&#31867;&#65292;
			&#20320;&#30340;&#37038;&#20214;&#20869;&#23481;&#23558;&#21464;&#24471;&#31616;&#21333;&#65292;&#36825;&#21516;&#26102;&#20063;&#26159;&#19968;&#20010;&#26368;&#20339;&#23454;&#36341;&#12290;&#19979;&#38754;&#26159;&#19968;&#20010;&#20351;&#29992;Velocity&#26469;&#21019;&#24314;&#37038;&#20214;&#20869;&#23481;&#30340;&#20363;&#23376;&#65306;
			</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="mail-templates-example"></a>22.3.2.1.&nbsp;&#19968;&#20010;&#22522;&#20110;Velocity&#30340;&#31034;&#20363;</h4></div></div><div></div></div><p>&#20351;&#29992;<a href="http://velocity.apache.org" target="_top">Velocity</a>&#26469;&#21019;&#24314;&#20320;&#30340;&#37038;&#20214;&#27169;&#26495;&#65292;&#20320;&#38656;&#35201;&#25226;Velocity&#21152;&#20837;&#21040;classpath&#20013;&#12290;
				&#21516;&#26102;&#35201;&#26681;&#25454;&#24212;&#29992;&#30340;&#38656;&#35201;&#20026;&#37038;&#20214;&#20869;&#23481;&#21019;&#24314;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;Velocity&#27169;&#26495;&#12290;&#19979;&#38754;&#30340;Velocity&#27169;&#26495;&#26159;&#36825;&#20010;&#20363;&#23376;&#20013;&#25152;&#20351;&#29992;&#30340;&#22522;&#20110;HTML&#30340;&#27169;&#26495;&#12290;
				&#36825;&#21482;&#26159;&#19968;&#20010;&#26222;&#36890;&#30340;&#25991;&#26412;&#65292;&#20320;&#21487;&#20197;&#36890;&#36807;&#21508;&#31181;&#20854;&#20182;&#30340;&#32534;&#36753;&#22120;&#26469;&#32534;&#36753;&#35813;&#25991;&#26412;&#65292;&#32780;&#26080;&#38656;&#20102;&#35299;Java&#26041;&#38754;&#30340;&#30693;&#35782;&#12290;</p><pre class="programlisting"><i class="lineannotation"><span class="lineannotation"># in the <tt class="literal">com/foo/package</tt></span></i>
&lt;html&gt;
&lt;body&gt;
&lt;h3&gt;Hi ${user.userName}, welcome to the Chipping Sodbury On-the-Hill message boards!&lt;/h3&gt;

&lt;div&gt;
   Your email address is &lt;a href="mailto:${user.emailAddress}"&gt;${user.emailAddress}&lt;/a&gt;.
&lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;</pre><p>&#19979;&#38754;&#25552;&#20379;&#20102;&#19968;&#20123;&#31616;&#21333;&#30340;&#20195;&#30721;&#19982;Spring XML&#37197;&#32622;&#65292;&#23427;&#20204;&#20351;&#29992;&#20102;&#19978;&#36848;Velocity&#27169;&#26495;&#26469;&#21019;&#24314;&#37038;&#20214;&#20869;&#23481;&#24182;&#21457;&#36865;&#37038;&#20214;&#12290;</p><pre class="programlisting">package com.foo;

import org.apache.velocity.app.VelocityEngine;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.mail.javamail.MimeMessagePreparator;
import org.springframework.ui.velocity.VelocityEngineUtils;

import javax.mail.internet.MimeMessage;
import java.util.HashMap;
import java.util.Map;

public class SimpleRegistrationService implements RegistrationService {

   private JavaMailSender mailSender;
   private VelocityEngine velocityEngine;

   public void setMailSender(JavaMailSender mailSender) {
      this.mailSender = mailSender;
   }

   public void setVelocityEngine(VelocityEngine velocityEngine) {
      this.velocityEngine = velocityEngine;
   }

   public void register(User user) {

      <i class="lineannotation"><span class="lineannotation">// Do the registration logic...</span></i>

      sendConfirmationEmail(user);
   }

   private void sendConfirmationEmail(final User user) {
      MimeMessagePreparator preparator = new MimeMessagePreparator() {
         public void prepare(MimeMessage mimeMessage) throws Exception {
            MimeMessageHelper message = new MimeMessageHelper(mimeMessage);
            message.setTo(user.getEmailAddress());
            message.setFrom("webmaster@csonth.gov.uk"); <i class="lineannotation"><span class="lineannotation">// could be parameterized...</span></i>
            Map model = new HashMap();
            model.put("user", user);
            String text = VelocityEngineUtils.mergeTemplateIntoString(
               velocityEngine, "com/dns/registration-confirmation.vm", model);
            message.setText(text, true);
         }
      };
      this.mailSender.send(preparator);
   }
}</pre><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"&gt;

   &lt;bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"&gt;
      &lt;property name="host" value="mail.csonth.gov.uk"/&gt;
   &lt;/bean&gt;

   &lt;bean id="registrationService" class="com.foo.SimpleRegistrationService"&gt;
      &lt;property name="mailSender" ref="mailSender"/&gt;
      &lt;property name="velocityEngine" ref="velocityEngine"/&gt;
   &lt;/bean&gt;
   
   &lt;bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean"&gt;
      &lt;property name="velocityProperties"&gt;
         &lt;value&gt;
            resource.loader=class
            class.resource.loader.class=org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader
         &lt;/value&gt;
      &lt;/property&gt;
   &lt;/bean&gt;

&lt;/beans&gt;</pre></div></div></div></div><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="cci.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="scheduling.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;21.&nbsp;JCA CCI&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.springsource.com/" title="SpringSource">Sponsored by SpringSource</a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;23.&nbsp;Spring&#20013;&#30340;&#23450;&#26102;&#35843;&#24230;(Scheduling)&#21644;&#32447;&#31243;&#27744;(Thread Pooling)</td></tr></table></div></body></html>