<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>44.&nbsp;Spring Security FAQ</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Security Reference"><link rel="up" href="appendix.html" title="Part&nbsp;VIII.&nbsp;Appendix"><link rel="prev" href="appendix-proxy-server.html" title="43.&nbsp;Proxy Server Configuration"><link rel="next" href="m3to4.html" title="45.&nbsp;Migrating from 3.x to 4.x"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">44.&nbsp;Spring Security FAQ</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="appendix-proxy-server.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;VIII.&nbsp;Appendix</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="m3to4.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-faq" href="#appendix-faq"></a>44.&nbsp;Spring Security FAQ</h2></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-general-questions" title="44.1&nbsp;General Questions">Section&nbsp;44.1, &#8220;General Questions&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-common-problems" title="44.2&nbsp;Common Problems">Section&nbsp;44.2, &#8220;Common Problems&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-architecture" title="44.3&nbsp;Spring Security Architecture Questions">Section&nbsp;44.3, &#8220;Spring Security Architecture Questions&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-howto" title="44.4&nbsp;Common &#34;Howto&#34; Requests">Section&nbsp;44.4, &#8220;Common "Howto" Requests&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-general-questions" href="#appendix-faq-general-questions"></a>44.1&nbsp;General Questions</h2></div></div></div>

<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-other-concerns" title="44.1.1&nbsp;Will Spring Security take care of all my application security requirements?">Section&nbsp;44.1.1, &#8220;Will Spring Security take care of all my application security requirements?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-web-xml" title="44.1.2&nbsp;Why not just use web.xml security?">Section&nbsp;44.1.2, &#8220;Why not just use web.xml security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-requirements" title="44.1.3&nbsp;What Java and Spring Framework versions are required?">Section&nbsp;44.1.3, &#8220;What Java and Spring Framework versions are required?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-start-simple" title="44.1.4&nbsp;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?">Section&nbsp;44.1.4, &#8220;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-other-concerns" href="#appendix-faq-other-concerns"></a>44.1.1&nbsp;Will Spring Security take care of all my application security requirements?</h3></div></div></div>

<p>Spring Security provides you with a very flexible framework for your authentication and authorization requirements, but there are many other considerations for building a secure application that are outside its scope. Web applications are vulnerable to all kinds of attacks which you should be familiar with, preferably before you start development so you can design and code with them in mind from the beginning. Check out thehttp://www.owasp.org/[OWASP web site] for information on the major issues facing web application developers and the countermeasures you can use against them.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-web-xml" href="#appendix-faq-web-xml"></a>44.1.2&nbsp;Why not just use web.xml security?</h3></div></div></div>

<p>Let&#8217;s assume you&#8217;re developing an enterprise application based on Spring. There are four security concerns you typically need to address: authentication, web request security, service layer security (i.e. your methods that implement business logic), and domain object instance security (i.e. different domain objects have different permissions). With these typical requirements in mind:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<span class="emphasis"><em>Authentication</em></span>: The servlet specification provides an approach to authentication. However, you will need to configure the container to perform authentication which typically requires editing of container-specific "realm" settings. This makes a non-portable configuration, and if you need to write an actual Java class to implement the container&#8217;s authentication interface, it becomes even more non-portable. With Spring Security you achieve complete portability - right down to the WAR level. Also, Spring Security offers a choice of production-proven authentication providers and mechanisms, meaning you can switch your authentication approaches at deployment time. This is particularly valuable for software vendors writing products that need to work in an unknown target environment.
</li><li class="listitem">
<span class="emphasis"><em>Web request security:</em></span> The servlet specification provides an approach to secure your request URIs. However, these URIs can only be expressed in the servlet specification&#8217;s own limited URI path format. Spring Security provides a far more comprehensive approach. For instance, you can use Ant paths or regular expressions, you can consider parts of the URI other than simply the requested page (e.g. you can consider HTTP GET parameters) and you can implement your own runtime source of configuration data. This means your web request security can be dynamically changed during the actual execution of your webapp.
</li><li class="listitem">
<p class="simpara"><span class="emphasis"><em>Service layer and domain object security:</em></span> The absence of support in the servlet specification for services layer security or domain object instance security represent serious limitations for multi-tiered applications. Typically developers either ignore these requirements, or implement security logic within their MVC controller code (or even worse, inside the views). There are serious disadvantages with this approach:</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<span class="emphasis"><em>Separation of concerns:</em></span> Authorization is a crosscutting concern and should be implemented as such. MVC controllers or views implementing authorization code makes it more difficult to test both the controller and authorization logic, more difficult to debug, and will often lead to code duplication.
</li><li class="listitem">
<span class="emphasis"><em>Support for rich clients and web services:</em></span> If an additional client type must ultimately be supported, any authorization code embedded within the web layer is non-reusable. It should be considered that Spring remoting exporters only export service layer beans (not MVC controllers). As such authorization logic needs to be located in the services layer to support a multitude of client types.
</li><li class="listitem">
<span class="emphasis"><em>Layering issues:</em></span> An MVC controller or view is simply the incorrect architectural layer to implement authorization decisions concerning services layer methods or domain object instances. Whilst the Principal may be passed to the services layer to enable it to make the authorization decision, doing so would introduce an additional argument on every services layer method. A more elegant approach is to use a ThreadLocal to hold the Principal, although this would likely increase development time to a point where it would become more economical (on a cost-benefit basis) to simply use a dedicated security framework.
</li><li class="listitem">
<span class="emphasis"><em>Authorisation code quality:</em></span> It is often said of web frameworks that they "make it easier to do the right things, and harder to do the wrong things". Security frameworks are the same, because they are designed in an abstract manner for a wide range of purposes. Writing your own authorization code from scratch does not provide the "design check" a framework would offer, and in-house authorization code will typically lack the improvements that emerge from widespread deployment, peer review and new versions.
</li></ol></div>
</li></ol></div>
<p>For simple applications, servlet specification security may just be enough. Although when considered within the context of web container portability, configuration requirements, limited web request security flexibility, and non-existent services layer and domain object instance security, it becomes clear why developers often look to alternative solutions.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-requirements" href="#appendix-faq-requirements"></a>44.1.3&nbsp;What Java and Spring Framework versions are required?</h3></div></div></div>

<p>Spring Security 3.0 and 3.1 require at least JDK 1.5 and also require Spring 3.0.3 as a minimum. Ideally you should be using the latest release versions to avoid problems.</p>
<p>Spring Security 2.0.x requires a minimum JDK version of 1.4 and is built against Spring 2.0.x. It should also be compatible with applications using Spring 2.5.x.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-start-simple" href="#appendix-faq-start-simple"></a>44.1.4&nbsp;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?</h3></div></div></div>

<p>Or subsititute an alternative complex scenario&#8230;&#8203;</p>
<p>Realistically, you need an understanding of the technolgies you are intending to use before you can successfully build applications with them. Security is complicated. Setting up a simple configuration using a login form and some hard-coded users using Spring Security&#8217;s namespace is reasonably straightforward. Moving to using a backed JDBC database is also easy enough. But if you try and jump straight to a complicated deployment scenario like this you will almost certainly be frustrated. There is a big jump in the learning curve required to set up systems like CAS, configure LDAP servers and install SSL certificates properly. So you need to take things one step at a time.</p>
<p>From a Spring Security perspective, the first thing you should do is follow the "Getting Started" guide on the web site. This will take you through a series of steps to get up and running and get some idea of how the framework operates. If you are using other technologies which you aren&#8217;t familiar with then you should do some research and try to make sure you can use them in isolation before combining them in a complex system.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-common-problems" href="#appendix-faq-common-problems"></a>44.2&nbsp;Common Problems</h2></div></div></div>

<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">Authentication</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-bad-credentials" title="44.2.1&nbsp;When I try to log in, I get an error message that says &#34;Bad Credentials&#34;. What&#8217;s wrong?">Section&nbsp;44.2.1, &#8220;When I try to log in, I get an error message that says "Bad Credentials". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-login-loop" title="44.2.2&nbsp;My application goes into an &#34;endless loop&#34; when I try to login, what&#8217;s going on?">Section&nbsp;44.2.2, &#8220;My application goes into an "endless loop" when I try to login, what&#8217;s going on?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-anon-access-denied" title="44.2.3&nbsp;I get an exception with the message &#34;Access is denied (user is anonymous);&#34;. What&#8217;s wrong?">Section&nbsp;44.2.3, &#8220;I get an exception with the message "Access is denied (user is anonymous);". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-cached-secure-page" title="44.2.4&nbsp;Why can I still see a secured page even after I&#8217;ve logged out of my application?">Section&nbsp;44.2.4, &#8220;Why can I still see a secured page even after I&#8217;ve logged out of my application?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#auth-exception-credentials-not-found" title="44.2.5&nbsp;I get an exception with the message &#34;An Authentication object was not found in the SecurityContext&#34;. What&#8217;s wrong?">Section&nbsp;44.2.5, &#8220;I get an exception with the message "An Authentication object was not found in the SecurityContext". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-ldap-authentication" title="44.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?">Section&nbsp;44.2.6, &#8220;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?&#8221;</a>
</li></ol></div>
</li><li class="listitem">
<p class="simpara">Session Management</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-concurrent-session-same-browser" title="44.2.8&nbsp;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?">Section&nbsp;44.2.8, &#8220;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-new-session-on-authentication" title="44.2.9&nbsp;Why does the session Id change when I authenticate through Spring Security?">Section&nbsp;44.2.9, &#8220;Why does the session Id change when I authenticate through Spring Security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-tomcat-https-session" title="44.2.10&nbsp;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.">Section&nbsp;44.2.10, &#8220;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-session-listener-missing" title="44.2.12&nbsp;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.">Section&nbsp;44.2.12, &#8220;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-unwanted-session-creation" title="44.2.13&nbsp;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.">Section&nbsp;44.2.13, &#8220;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.&#8221;</a>
</li></ol></div>
</li><li class="listitem">
<p class="simpara">Miscellaneous</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-forbidden-csrf" title="44.2.14&nbsp;I get a 403 Forbidden when performing a POST">Section&nbsp;44.2.14, &#8220;I get a 403 Forbidden when performing a POST&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-no-security-on-forward" title="44.2.15&nbsp;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.">Section&nbsp;44.2.15, &#8220;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-method-security-in-web-context" title="44.2.16&nbsp;I have added Spring Security&#8217;s <global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.">Section&nbsp;44.2.16, &#8220;I have added Spring Security&#8217;s &lt;global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-no-filters-no-context" title="44.2.17&nbsp;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?">Section&nbsp;44.2.17, &#8220;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-method-security-with-taglib" title="44.2.18&nbsp;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.">Section&nbsp;44.2.18, &#8220;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.&#8221;</a>
</li></ol></div>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-bad-credentials" href="#appendix-faq-bad-credentials"></a>44.2.1&nbsp;When I try to log in, I get an error message that says "Bad Credentials". What&#8217;s wrong?</h3></div></div></div>

<p>This means that authentication has failed. It doesn&#8217;t say why, as it is good practice to avoid giving details which might help an attacker guess account names or passwords.</p>
<p>This also means that if you ask this question in the forum, you will not get an answer unless you provide additional information. As with any issue you should check the output from the debug log, note any exception stacktraces and related messages. Step through the code in a debugger to see where the authentication fails and why. Write a test case which exercises your authentication configuration outside of the application. More often than not, the failure is due to a difference in the password data stored in a database and that entered by the user. If you are using hashed passwords, make sure the value stored in your database is <span class="emphasis"><em>exactly</em></span> the same as the value produced by the <code class="literal">PasswordEncoder</code> configured in your application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-login-loop" href="#appendix-faq-login-loop"></a>44.2.2&nbsp;My application goes into an "endless loop" when I try to login, what&#8217;s going on?</h3></div></div></div>

<p>A common user problem with infinite loop and redirecting to the login page is caused by accidently configuring the login page as a "secured" resource. Make sure your configuration allows anonymous access to the login page, either by excluding it from the security filter chain or marking it as requiring ROLE_ANONYMOUS.</p>
<p>If your AccessDecisionManager includes an AuthenticatedVoter, you can use the attribute "IS_AUTHENTICATED_ANONYMOUSLY". This is automatically available if you are using the standard namespace configuration setup.</p>
<p>From Spring Security 2.0.1 onwards, when you are using namespace-based configuration, a check will be made on loading the application context and a warning message logged if your login page appears to be protected.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-anon-access-denied" href="#appendix-faq-anon-access-denied"></a>44.2.3&nbsp;I get an exception with the message "Access is denied (user is anonymous);". What&#8217;s wrong?</h3></div></div></div>

<p>This is a debug level message which occurs the first time an anonymous user attempts to access a protected resource.</p>
<pre class="screen">DEBUG [ExceptionTranslationFilter] - Access is denied (user is anonymous); redirecting to authentication entry point
org.springframework.security.AccessDeniedException: Access is denied
at org.springframework.security.vote.AffirmativeBased.decide(AffirmativeBased.java:68)
at org.springframework.security.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:262)</pre>
<p>It is normal and shouldn&#8217;t be anything to worry about.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-cached-secure-page" href="#appendix-faq-cached-secure-page"></a>44.2.4&nbsp;Why can I still see a secured page even after I&#8217;ve logged out of my application?</h3></div></div></div>

<p>The most common reason for this is that your browser has cached the page and you are seeing a copy which is being retrieved from the browsers cache. Verify this by checking whether the browser is actually sending the request (check your server access logs, the debug log or use a suitable browser debugging plugin such as "Tamper Data" for Firefox). This has nothing to do with Spring Security and you should configure your application or server to set the appropriate <code class="literal">Cache-Control</code> response headers. Note that SSL requests are never cached.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="auth-exception-credentials-not-found" href="#auth-exception-credentials-not-found"></a>44.2.5&nbsp;I get an exception with the message "An Authentication object was not found in the SecurityContext". What&#8217;s wrong?</h3></div></div></div>

<p>This is a another debug level message which occurs the first time an anonymous user attempts to access a protected resource, but when you do not have an <code class="literal">AnonymousAuthenticationFilter</code> in your filter chain configuration.</p>
<pre class="screen">DEBUG [ExceptionTranslationFilter] - Authentication exception occurred; redirecting to authentication entry point
org.springframework.security.AuthenticationCredentialsNotFoundException:
							An Authentication object was not found in the SecurityContext
at org.springframework.security.intercept.AbstractSecurityInterceptor.credentialsNotFound(AbstractSecurityInterceptor.java:342)
at org.springframework.security.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:254)</pre>
<p>It is normal and shouldn&#8217;t be anything to worry about.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-ldap-authentication" href="#appendix-faq-ldap-authentication"></a>44.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?</h3></div></div></div>

<p>Note that the permissions for an LDAP directory often do not allow you to read the password for a user. Hence it is often not possible to use the <a class="xref" href="appendix-faq.html#appendix-faq-what-is-userdetailservice" title="44.3.6&nbsp;What is a UserDetailsService and do I need one?">Section&nbsp;44.3.6, &#8220;What is a UserDetailsService and do I need one?&#8221;</a> where Spring Security compares the stored password with the one submitted by the user. The most common approach is to use LDAP "bind", which is one of the operations supported by <a class="ulink" href="http://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_top">the LDAP protocol</a>. With this approach, Spring Security validates the password by attempting to authenticate to the directory as the user.</p>
<p>The most common problem with LDAP authentication is a lack of knowledge of the directory server tree structure and configuration. This will be different in different companies, so you have to find it out yourself. Before adding a Spring Security LDAP configuration to an application, it&#8217;s a good idea to write a simple test using standard Java LDAP code (without Spring Security involved), and make sure you can get that to work first. For example, to authenticate a user, you could use the following code:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> ldapAuthenticationIsSuccessful() <span class="hl-keyword">throws</span> Exception {
		Hashtable&lt;String,String&gt; env = <span class="hl-keyword">new</span> Hashtable&lt;String,String&gt;();
		env.put(Context.SECURITY_AUTHENTICATION, <span class="hl-string">"simple"</span>);
		env.put(Context.SECURITY_PRINCIPAL, <span class="hl-string">"cn=joe,ou=users,dc=mycompany,dc=com"</span>);
		env.put(Context.PROVIDER_URL, <span class="hl-string">"ldap://mycompany.com:389/dc=mycompany,dc=com"</span>);
		env.put(Context.SECURITY_CREDENTIALS, <span class="hl-string">"joespassword"</span>);
		env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="hl-string">"com.sun.jndi.ldap.LdapCtxFactory"</span>);

		InitialLdapContext ctx = <span class="hl-keyword">new</span> InitialLdapContext(env, null);

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="session-management" href="#session-management"></a>44.2.7&nbsp;Session Management</h3></div></div></div>

<p>Session management issues are a common source of forum questions. If you are developing Java web applications, you should understand how the session is maintained between the servlet container and the user&#8217;s browser. You should also understand the difference between secure and non-secure cookies and the implications of using HTTP/HTTPS and switching between the two. Spring Security has nothing to do with maintaining the session or providing session identifiers. This is entirely handled by the servlet container.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-concurrent-session-same-browser" href="#appendix-faq-concurrent-session-same-browser"></a>44.2.8&nbsp;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?</h3></div></div></div>

<p>Browsers generally maintain a single session per browser instance. You cannot have two separate sessions at once. So if you log in again in another window or tab you are just reauthenticating in the same session. The server doesn&#8217;t know anything about tabs, windows or browser instances. All it sees are HTTP requests and it ties those to a particular session according to the value of the JSESSIONID cookie that they contain. When a user authenticates during a session, Spring Security&#8217;s concurrent session control checks the number of<span class="emphasis"><em>other authenticated sessions</em></span> that they have. If they are already authenticated with the same session, then re-authenticating will have no effect.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-new-session-on-authentication" href="#appendix-faq-new-session-on-authentication"></a>44.2.9&nbsp;Why does the session Id change when I authenticate through Spring Security?</h3></div></div></div>

<p>With the default configuration, Spring Security changes the session ID when the user authenticates. If you&#8217;re using a Servlet 3.1 or newer container, the session ID is simply changed. If you&#8217;re using an older container, Spring Security invalidates the existing session, creates a new session, and transfers the session data to the new session. Changing the session identifier in this manner prevents"session-fixation" attacks. You can find more about this online and in the reference manual.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-tomcat-https-session" href="#appendix-faq-tomcat-https-session"></a>44.2.10&nbsp;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.</h3></div></div></div>

<p>This happens because sessions created under HTTPS, for which the session cookie is marked as "secure", cannot subsequently be used under HTTP. The browser will not send the cookie back to the server and any session state will be lost (including the security context information). Starting a session in HTTP first should work as the session cookie won&#8217;t be marked as secure. However, Spring Security&#8217;s <a class="ulink" href="http://static.springsource.org/spring-security/site/docs/3.1.x/reference/springsecurity-single.html#ns-session-fixation" target="_top">Session Fixation Protection</a> can interfere with this because it results in a new session ID cookie being sent back to the user&#8217;s browser, usually with the secure flag. To get around this, you can disable session fixation protection, but in newer Servlet containers you can also configure session cookies to never use the secure flag. Note that switching between HTTP and HTTPS is not a good idea in general, as any application which uses HTTP at all is vulnerable to man-in-the-middle attacks. To be truly secure, the user should begin accessing your site in HTTPS and continue using it until they log out. Even clicking on an HTTPS link from a page accessed over HTTP is potentially risky. If you need more convincing, check out a tool like <a class="ulink" href="http://www.thoughtcrime.org/software/sslstrip/" target="_top">sslstrip</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="i-m-not-switching-between-http-and-https-but-my-session-is-still-getting-lost" href="#i-m-not-switching-between-http-and-https-but-my-session-is-still-getting-lost"></a>44.2.11&nbsp;I&#8217;m not switching between HTTP and HTTPS but my session is still getting lost</h3></div></div></div>

<p>Sessions are maintained either by exchanging a session cookie or by adding a <code class="literal">jsessionid</code> parameter to URLs (this happens automatically if you are using JSTL to output URLs, or if you call <code class="literal">HttpServletResponse.encodeUrl</code> on URLs (before a redirect, for example). If clients have cookies disabled, and you are not rewriting URLs to include the <code class="literal">jsessionid</code>, then the session will be lost. Note that the use of cookies is preferred for security reasons, as it does not expose the session information in the URL.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-session-listener-missing" href="#appendix-faq-session-listener-missing"></a>44.2.12&nbsp;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.</h3></div></div></div>

<p>Make sure you have added the listener to your web.xml file. It is essential to make sure that the Spring Security session registry is notified when a session is destroyed. Without it, the session information will not be removed from the registry.</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
		<span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-unwanted-session-creation" href="#appendix-faq-unwanted-session-creation"></a>44.2.13&nbsp;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.</h3></div></div></div>

<p>This usually means that the user&#8217;s application is creating a session somewhere, but that they aren&#8217;t aware of it. The most common culprit is a JSP. Many people aren&#8217;t aware that JSPs create sessions by default. To prevent a JSP from creating a session, add the directive <code class="literal">&lt;%@ page session="false" %&gt;</code> to the top of the page.</p>
<p>If you are having trouble working out where a session is being created, you can add some debugging code to track down the location(s). One way to do this would be to add a <code class="literal">javax.servlet.http.HttpSessionListener</code> to your application, which calls <code class="literal">Thread.dumpStack()</code> in the <code class="literal">sessionCreated</code> method.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-forbidden-csrf" href="#appendix-faq-forbidden-csrf"></a>44.2.14&nbsp;I get a 403 Forbidden when performing a POST</h3></div></div></div>

<p>If an HTTP 403 Forbidden is returned for HTTP POST, but works for HTTP GET then the issue is most likely related to <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#csrf" target="_top">CSRF</a>. Either provide the CSRF Token or disable CSRF protection (not recommended).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-no-security-on-forward" href="#appendix-faq-no-security-on-forward"></a>44.2.15&nbsp;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.</h3></div></div></div>

<p>Filters are not applied by default to forwards or includes. If you really want the security filters to be applied to forwards and/or includes, then you have to configure these explicitly in your web.xml using the &lt;dispatcher&gt; element, a child element of &lt;filter-mapping&gt;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-method-security-in-web-context" href="#appendix-faq-method-security-in-web-context"></a>44.2.16&nbsp;I have added Spring Security&#8217;s &lt;global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.</h3></div></div></div>

<p>In a Spring web application, the application context which holds the Spring MVC beans for the dispatcher servlet is often separate from the main application context. It is often defined in a file called <code class="literal">myapp-servlet.xml</code>, where "myapp" is the name assigned to the Spring <code class="literal">DispatcherServlet</code> in <code class="literal">web.xml</code>. An application can have multiple <code class="literal">DispatcherServlet</code>s, each with its own isolated application context. The beans in these "child" contexts are not visible to the rest of the application. The"parent" application context is loaded by the <code class="literal">ContextLoaderListener</code> you define in your <code class="literal">web.xml</code> and is visible to all the child contexts. This parent context is usually where you define your security configuration, including the <code class="literal">&lt;global-method-security&gt;</code> element). As a result any security constraints applied to methods in these web beans will not be enforced, since the beans cannot be seen from the <code class="literal">DispatcherServlet</code> context. You need to either move the <code class="literal">&lt;global-method-security&gt;</code> declaration to the web context or moved the beans you want secured into the main application context.</p>
<p>Generally we would recommend applying method security at the service layer rather than on individual web controllers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-no-filters-no-context" href="#appendix-faq-no-filters-no-context"></a>44.2.17&nbsp;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?</h3></div></div></div>

<p>If you have excluded the request from the security filter chain using the attribute <code class="literal">filters='none'</code> in the <code class="literal">&lt;intercept-url&gt;</code> element that matches the URL pattern, then the <code class="literal">SecurityContextHolder</code> will not be populated for that request. Check the debug log to see whether the request is passing through the filter chain. (You are reading the debug log, right?).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-method-security-with-taglib" href="#appendix-faq-method-security-with-taglib"></a>44.2.18&nbsp;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.</h3></div></div></div>

<p>Method security will not hide links when using the <code class="literal">url</code> attribute in <code class="literal">&lt;sec:authorize&gt;</code> because we cannot readily reverse engineer what URL is mapped to what controller endpoint as controllers can rely on headers, current user, etc to determine what method to invoke.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-architecture" href="#appendix-faq-architecture"></a>44.3&nbsp;Spring Security Architecture Questions</h2></div></div></div>

<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-where-is-class-x" title="44.3.1&nbsp;How do I know which package class X is in?">Section&nbsp;44.3.1, &#8220;How do I know which package class X is in?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-namespace-to-bean-mapping" title="44.3.2&nbsp;How do the namespace elements map to conventional bean configurations?">Section&nbsp;44.3.2, &#8220;How do the namespace elements map to conventional bean configurations?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-role-prefix" title="44.3.3&nbsp;What does &#34;ROLE_&#34; mean and why do I need it on my role names?">Section&nbsp;44.3.3, &#8220;What does "ROLE_" mean and why do I need it on my role names?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-what-dependencies" title="44.3.4&nbsp;How do I know which dependencies to add to my application to work with Spring Security?">Section&nbsp;44.3.4, &#8220;How do I know which dependencies to add to my application to work with Spring Security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-apacheds-deps" title="44.3.5&nbsp;What dependencies are needed to run an embedded ApacheDS LDAP server?">Section&nbsp;44.3.5, &#8220;What dependencies are needed to run an embedded ApacheDS LDAP server?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-what-is-userdetailservice" title="44.3.6&nbsp;What is a UserDetailsService and do I need one?">Section&nbsp;44.3.6, &#8220;What is a UserDetailsService and do I need one?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-where-is-class-x" href="#appendix-faq-where-is-class-x"></a>44.3.1&nbsp;How do I know which package class X is in?</h3></div></div></div>

<p>The best way of locating classes is by installing the Spring Security source in your IDE. The distribution includes source jars for each of the modules the project is divided up into. Add these to your project source path and you can navigate directly to Spring Security classes (<code class="literal">Ctrl-Shift-T</code> in Eclipse). This also makes debugging easier and allows you to troubleshoot exceptions by looking directly at the code where they occur to see what&#8217;s going on there.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-namespace-to-bean-mapping" href="#appendix-faq-namespace-to-bean-mapping"></a>44.3.2&nbsp;How do the namespace elements map to conventional bean configurations?</h3></div></div></div>

<p>There is a general overview of what beans are created by the namespace in the namespace appendix of the reference guide. There is also a detailed blog article called "Behind the Spring Security Namespace" on <a class="ulink" href="http://blog.springsource.com/2010/03/06/behind-the-spring-security-namespace/" target="_top">blog.springsource.com</a>. If want to know the full details then the code is in the <code class="literal">spring-security-config</code> module within the Spring Security 3.0 distribution. You should probably read the chapters on namespace parsing in the standard Spring Framework reference documentation first.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-role-prefix" href="#appendix-faq-role-prefix"></a>44.3.3&nbsp;What does "ROLE_" mean and why do I need it on my role names?</h3></div></div></div>

<p>Spring Security has a voter-based architecture which means that an access decision is made by a series of <code class="literal">AccessDecisionVoter</code>s. The voters act on the "configuration attributes" which are specified for a secured resource (such as a method invocation). With this approach, not all attributes may be relevant to all voters and a voter needs to know when it should ignore an attribute (abstain) and when it should vote to grant or deny access based on the attribute value. The most common voter is the <code class="literal">RoleVoter</code> which by default votes whenever it finds an attribute with the "ROLE_" prefix. It makes a simple comparison of the attribute (such as "ROLE_USER") with the names of the authorities which the current user has been assigned. If it finds a match (they have an authority called "ROLE_USER"), it votes to grant access, otherwise it votes to deny access.</p>
<p>The prefix can be changed by setting the <code class="literal">rolePrefix</code> property of <code class="literal">RoleVoter</code>. If you only need to use roles in your application and have no need for other custom voters, then you can set the prefix to a blank string, in which case the <code class="literal">RoleVoter</code> will treat all attributes as roles.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-what-dependencies" href="#appendix-faq-what-dependencies"></a>44.3.4&nbsp;How do I know which dependencies to add to my application to work with Spring Security?</h3></div></div></div>

<p>It will depend on what features you are using and what type of application you are developing. With Spring Security 3.0, the project jars are divided into clearly distinct areas of functionality, so it is straightforward to work out which Spring Security jars you need from your application requirements. All applications will need the <code class="literal">spring-security-core</code> jar. If you&#8217;re developing a web application, you need the <code class="literal">spring-security-web</code> jar. If you&#8217;re using security namespace configuration you need the <code class="literal">spring-security-config</code> jar, for LDAP support you need the <code class="literal">spring-security-ldap</code> jar and so on.</p>
<p>For third-party jars the situation isn&#8217;t always quite so obvious. A good starting point is to copy those from one of the pre-built sample applications WEB-INF/lib directories. For a basic application, you can start with the tutorial sample. If you want to use LDAP, with an embedded test server, then use the LDAP sample as a starting point. The reference manual also includeshttp://static.springsource.org/spring-security/site/docs/3.1.x/reference/springsecurity-single.html#appendix-dependencies[an appendix] listing the first-level dependencies for each Spring Security module with some information on whether they are optional and what they are required for.</p>
<p>If you are building your project with maven, then adding the appropriate Spring Security modules as dependencies to your pom.xml will automatically pull in the core jars that the framework requires. Any which are marked as "optional" in the Spring Security POM files will have to be added to your own pom.xml file if you need them.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-apacheds-deps" href="#appendix-faq-apacheds-deps"></a>44.3.5&nbsp;What dependencies are needed to run an embedded ApacheDS LDAP server?</h3></div></div></div>

<p>If you are using Maven, you need to add the folowing to your pom dependencies:</p>
<pre class="screen">&lt;dependency&gt;
		&lt;groupId&gt;org.apache.directory.server&lt;/groupId&gt;
		&lt;artifactId&gt;apacheds-core&lt;/artifactId&gt;
		&lt;version&gt;1.5.5&lt;/version&gt;
		&lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
		&lt;groupId&gt;org.apache.directory.server&lt;/groupId&gt;
		&lt;artifactId&gt;apacheds-server-jndi&lt;/artifactId&gt;
		&lt;version&gt;1.5.5&lt;/version&gt;
		&lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</pre>
<p>The other required jars should be pulled in transitively.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-what-is-userdetailservice" href="#appendix-faq-what-is-userdetailservice"></a>44.3.6&nbsp;What is a UserDetailsService and do I need one?</h3></div></div></div>

<p><code class="literal">UserDetailsService</code> is a DAO interface for loading data that is specific to a user account. It has no other function other to load that data for use by other components within the framework. It is not responsible for authenticating the user. Authenticating a user with a username/password combination is most commonly performed by the <code class="literal">DaoAuthenticationProvider</code>, which is injected with a <code class="literal">UserDetailsService</code> to allow it to load the password (and other data) for a user in order to compare it with the submitted value. Note that if you are using LDAP, <a class="link" href="appendix-faq.html#appendix-faq-ldap-authentication" title="44.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?">this approach may not work</a>.</p>
<p>If you want to customize the authentication process then you should implement <code class="literal">AuthenticationProvider</code> yourself. See this <a class="ulink" href="http://blog.springsource.com/2010/08/02/spring-security-in-google-app-engine/" target="_top"> blog article</a> for an example integrating Spring Security authentication with Google App Engine.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-howto" href="#appendix-faq-howto"></a>44.4&nbsp;Common "Howto" Requests</h2></div></div></div>

<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-extra-login-fields" title="44.4.1&nbsp;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?">Section&nbsp;44.4.1, &#8220;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-matching-url-fragments" title="44.4.2&nbsp;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?">Section&nbsp;44.4.2, &#8220;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-request-details-in-user-service" title="44.4.3&nbsp;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?">Section&nbsp;44.4.3, &#8220;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-access-session-from-user-service" title="44.4.4&nbsp;How do I access the HttpSession from a UserDetailsService?">Section&nbsp;44.4.4, &#8220;How do I access the HttpSession from a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-password-in-user-service" title="44.4.5&nbsp;How do I access the user&#8217;s password in a UserDetailsService?">Section&nbsp;44.4.5, &#8220;How do I access the user&#8217;s password in a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-dynamic-url-metadata" title="44.4.6&nbsp;How do I define the secured URLs within an application dynamically?">Section&nbsp;44.4.6, &#8220;How do I define the secured URLs within an application dynamically?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-ldap-authorities" title="44.4.7&nbsp;How do I authenticate against LDAP but load user roles from a database?">Section&nbsp;44.4.7, &#8220;How do I authenticate against LDAP but load user roles from a database?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="appendix-faq.html#appendix-faq-namespace-post-processor" title="44.4.8&nbsp;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?">Section&nbsp;44.4.8, &#8220;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-extra-login-fields" href="#appendix-faq-extra-login-fields"></a>44.4.1&nbsp;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?</h3></div></div></div>

<p>This question comes up repeatedly in the Spring Security forum so you                           will find more information there by searching the archives (or through google).</p>
<p>The submitted login information is processed by an instance of <code class="literal">UsernamePasswordAuthenticationFilter</code>. You will need to customize this class to handle the extra data field(s). One option is to use your own customized authentication token class (rather than the standard <code class="literal">UsernamePasswordAuthenticationToken</code>), another is simply to concatenate the extra fields with the username (for example, using a ":" as the separator) and pass them in the username property of <code class="literal">UsernamePasswordAuthenticationToken</code>.</p>
<p>You will also need to customize the actual authentication process. If you are using a custom authentication token class, for example, you will have to write an <code class="literal">AuthenticationProvider</code> to handle it (or extend the standard <code class="literal">DaoAuthenticationProvider</code>). If you have concatenated the fields, you can implement your own <code class="literal">UserDetailsService</code> which splits them up and loads the appropriate user data for authentication.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-matching-url-fragments" href="#appendix-faq-matching-url-fragments"></a>44.4.2&nbsp;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?</h3></div></div></div>

<p>You can&#8217;t do this, since the fragment is not transmitted from the browser to the server. The URLs above are identical from the server&#8217;s perspective. This is a common question from GWT users.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-request-details-in-user-service" href="#appendix-faq-request-details-in-user-service"></a>44.4.3&nbsp;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?</h3></div></div></div>

<p>Obviously you can&#8217;t (without resorting to something like thread-local variables) since the only information supplied to the interface is the username. Instead of implementing <code class="literal">UserDetailsService</code>, you should implement <code class="literal">AuthenticationProvider</code> directly and extract the information from the supplied <code class="literal">Authentication</code> token.</p>
<p>In a standard web setup, the <code class="literal">getDetails()</code> method on the <code class="literal">Authentication</code> object will return an instance of <code class="literal">WebAuthenticationDetails</code>. If you need additional information, you can inject a custom <code class="literal">AuthenticationDetailsSource</code> into the authentication filter you are using. If you are using the namespace, for example with the <code class="literal">&lt;form-login&gt;</code> element, then you should remove this element and replace it with a <code class="literal">&lt;custom-filter&gt;</code> declaration pointing to an explicitly configured <code class="literal">UsernamePasswordAuthenticationFilter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-access-session-from-user-service" href="#appendix-faq-access-session-from-user-service"></a>44.4.4&nbsp;How do I access the HttpSession from a UserDetailsService?</h3></div></div></div>

<p>You can&#8217;t, since the <code class="literal">UserDetailsService</code> has no awareness of the servlet API. If you want to store custom user data, then you should customize the <code class="literal">UserDetails</code> object which is returned. This can then be accessed at any point, via the thread-local <code class="literal">SecurityContextHolder</code>. A call to <code class="literal">SecurityContextHolder.getContext().getAuthentication().getPrincipal()</code> will return this custom object.</p>
<p>If you really need to access the session, then it must be done by customizing the web tier.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-password-in-user-service" href="#appendix-faq-password-in-user-service"></a>44.4.5&nbsp;How do I access the user&#8217;s password in a UserDetailsService?</h3></div></div></div>

<p>You can&#8217;t (and shouldn&#8217;t). You are probably misunderstanding its purpose. See "<a class="link" href="appendix-faq.html#appendix-faq-what-is-userdetailservice" title="44.3.6&nbsp;What is a UserDetailsService and do I need one?">What is a UserDetailsService?</a>" above.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-dynamic-url-metadata" href="#appendix-faq-dynamic-url-metadata"></a>44.4.6&nbsp;How do I define the secured URLs within an application dynamically?</h3></div></div></div>

<p>People often ask about how to store the mapping between secured URLs and security metadata attributes in a database, rather than in the application context.</p>
<p>The first thing you should ask yourself is if you really need to do this. If an application requires securing, then it also requires that the security be tested thoroughly based on a defined policy. It may require auditing and acceptance testing before being rolled out into a production environment. A security-conscious organization should be aware that the benefits of their diligent testing process could be wiped out instantly by allowing the security settings to be modified at runtime by changing a row or two in a configuration database. If you have taken this into account (perhaps using multiple layers of security within your application) then Spring Security allows you to fully customize the source of security metadata. You can make it fully dynamic if you choose.</p>
<p>Both method and web security are protected by subclasses of <code class="literal">AbstractSecurityInterceptor</code> which is configured with a <code class="literal">SecurityMetadataSource</code> from which it obtains the metadata for a particular method or filter invocation. For web security, the interceptor class is <code class="literal">FilterSecurityInterceptor</code> and it uses the marker interface <code class="literal">FilterInvocationSecurityMetadataSource</code>. The "secured object" type it operates on is a <code class="literal">FilterInvocation</code>. The default implementation which is used (both in the namespace <code class="literal">&lt;http&gt;</code> and when configuring the interceptor explicitly, stores the list of URL patterns and their corresponding list of "configuration attributes" (instances of <code class="literal">ConfigAttribute</code>) in an in-memory map.</p>
<p>To load the data from an alternative source, you must be using an explicitly declared security filter chain (typically Spring Security&#8217;s <code class="literal">FilterChainProxy</code>) in order to customize the <code class="literal">FilterSecurityInterceptor</code> bean. You can&#8217;t use the namespace. You would then implement <code class="literal">FilterInvocationSecurityMetadataSource</code> to load the data as you please for a particular <code class="literal">FilterInvocation</code> <a href="#ftn.d5e8834" class="footnote" name="d5e8834"><sup class="footnote">[25]</sup></a>. A very basic outline would look something like this:</p>
<pre class="programlisting">	<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFilterSecurityMetadataSource <span class="hl-keyword">implements</span> FilterInvocationSecurityMetadataSource {

		<span class="hl-keyword">public</span> List&lt;ConfigAttribute&gt; getAttributes(Object object) {
			FilterInvocation fi = (FilterInvocation) object;
				String url = fi.getRequestUrl();
				String httpMethod = fi.getRequest().getMethod();
				List&lt;ConfigAttribute&gt; attributes = <span class="hl-keyword">new</span> ArrayList&lt;ConfigAttribute&gt;();

				<span class="hl-comment">// Lookup your database (or other source) using this information and populate the</span>
				<span class="hl-comment">// list of attributes</span>

				<span class="hl-keyword">return</span> attributes;
		}

		<span class="hl-keyword">public</span> Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() {
			<span class="hl-keyword">return</span> null;
		}

		<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> supports(Class&lt;?&gt; clazz) {
			<span class="hl-keyword">return</span> FilterInvocation.<span class="hl-keyword">class</span>.isAssignableFrom(clazz);
		}
	}</pre>
<p>For more information, look at the code for <code class="literal">DefaultFilterInvocationSecurityMetadataSource</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-ldap-authorities" href="#appendix-faq-ldap-authorities"></a>44.4.7&nbsp;How do I authenticate against LDAP but load user roles from a database?</h3></div></div></div>

<p>The <code class="literal">LdapAuthenticationProvider</code> bean (which handles normal LDAP authentication in Spring Security) is configured with two separate strategy interfaces, one which performs the authentication and one which loads the user authorities, called <code class="literal">LdapAuthenticator</code> and <code class="literal">LdapAuthoritiesPopulator</code> respectively. The <code class="literal">DefaultLdapAuthoritiesPopulator</code> loads the user authorities from the LDAP directory and has various configuration parameters to allow you to specify how these should be retrieved.</p>
<p>To use JDBC instead, you can implement the interface yourself, using whatever SQL is appropriate for your schema:</p>
<pre class="programlisting">	<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAuthoritiesPopulator <span class="hl-keyword">implements</span> LdapAuthoritiesPopulator {
		<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
		JdbcTemplate template;

		List&lt;GrantedAuthority&gt; getGrantedAuthorities(DirContextOperations userData, String username) {
			List&lt;GrantedAuthority&gt; = template.query(<span class="hl-string">"select role from roles where username = ?"</span>,
																									<span class="hl-keyword">new</span> String[] {username},
																									<span class="hl-keyword">new</span> RowMapper&lt;GrantedAuthority&gt;() {
				<strong class="hl-tag" style="color: blue">/**
				 *  We're assuming here that you're using the standard convention of using the role
				 *  prefix "ROLE_" to mark attributes which are supported by Spring Security's RoleVoter.
				 */</strong>
				<span class="hl-keyword">public</span> GrantedAuthority mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
					<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SimpleGrantedAuthority(<span class="hl-string">"ROLE_"</span> + rs.getString(<span class="hl-number">1</span>);
				}
			}
		}
	}</pre>
<p>You would then add a bean of this type to your application context and inject it into the <code class="literal">LdapAuthenticationProvider</code>. This is covered in the section on configuring LDAP using explicit Spring beans in the LDAP chapter of the reference manual. Note that you can&#8217;t use the namespace for configuration in this case. You should also consult the Javadoc for the relevant classes and interfaces.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-namespace-post-processor" href="#appendix-faq-namespace-post-processor"></a>44.4.8&nbsp;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?</h3></div></div></div>

<p>The namespace functionality is intentionally limited, so it doesn&#8217;t cover everything that you can do with plain beans. If you want to do something simple, like modify a bean, or inject a different dependency, you can do this by adding a <code class="literal">BeanPostProcessor</code> to your configuration. More information can be found in the <a class="ulink" href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/htmlsingle/spring-framework-reference.html#beans-factory-extension-bpp" target="_top">Spring Reference Manual</a>. In order to do this, you need to know a bit about which beans are created, so you should also read the blog article in the above question on <a class="link" href="appendix-faq.html#appendix-faq-namespace-to-bean-mapping" title="44.3.2&nbsp;How do the namespace elements map to conventional bean configurations?">how the namespace maps to Spring beans</a>.</p>
<p>Normally, you would add the functionality you require to the <code class="literal">postProcessBeforeInitialization</code> method of <code class="literal">BeanPostProcessor</code>. Let&#8217;s say that you want to customize the <code class="literal">AuthenticationDetailsSource</code> used by the <code class="literal">UsernamePasswordAuthenticationFilter</code>, (created by the <code class="literal">form-login</code> element). You want to extract a particular header called <code class="literal">CUSTOM_HEADER</code> from the request and make use of it while authenticating the user. The processor class would look like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BeanPostProcessor <span class="hl-keyword">implements</span> BeanPostProcessor {

		<span class="hl-keyword">public</span> Object postProcessAfterInitialization(Object bean, String name) {
				<span class="hl-keyword">if</span> (bean <span class="hl-keyword">instanceof</span> UsernamePasswordAuthenticationFilter) {
						System.out.println(<span class="hl-string">"********* Post-processing "</span> + name);
						((UsernamePasswordAuthenticationFilter)bean).setAuthenticationDetailsSource(
										<span class="hl-keyword">new</span> AuthenticationDetailsSource() {
												<span class="hl-keyword">public</span> Object buildDetails(Object context) {
														<span class="hl-keyword">return</span> ((HttpServletRequest)context).getHeader(<span class="hl-string">"CUSTOM_HEADER"</span>);
												}
										});
				}
				<span class="hl-keyword">return</span> bean;
		}

		<span class="hl-keyword">public</span> Object postProcessBeforeInitialization(Object bean, String name) {
				<span class="hl-keyword">return</span> bean;
		}
}</pre>
<p>You would then register this bean in your application context. Spring will automatically invoke it on the beans defined in the application context.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e8834" class="footnote"><p><a href="#d5e8834" class="simpara"><sup class="simpara">[25] </sup></a>The <code class="literal">FilterInvocation</code> object contains the <code class="literal">HttpServletRequest</code>, so you can obtain the URL or any other relevant information on which to base your decision on what the list of returned attributes will contain.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="appendix-proxy-server.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="appendix.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="m3to4.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">43.&nbsp;Proxy Server Configuration&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;45.&nbsp;Migrating from 3.x to 4.x</td></tr></table></div></body></html>