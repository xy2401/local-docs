<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>5.&nbsp;Java Configuration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Security Reference"><link rel="up" href="preface.html" title="Part&nbsp;I.&nbsp;Preface"><link rel="prev" href="samples.html" title="4.&nbsp;Samples and Guides (Start Here)"><link rel="next" href="ns-config.html" title="6.&nbsp;Security Namespace Configuration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.&nbsp;Java Configuration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="samples.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;I.&nbsp;Preface</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ns-config.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jc" href="#jc"></a>5.&nbsp;Java Configuration</h2></div></div></div>

<p>General support for <a class="ulink" href="http://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/beans.html#beans-java" target="_top">Java Configuration</a> was added to Spring Framework in Spring 3.1. Since Spring Security 3.2 there has been Spring Security Java Configuration support which enables users to easily configure Spring Security without the use of any XML.</p>
<p>If you are familiar with the <a class="xref" href="ns-config.html" title="6.&nbsp;Security Namespace Configuration">Chapter&nbsp;6, <i>Security Namespace Configuration</i></a> then you should find quite a few similarities between it and the Security Java Configuration support.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Security provides <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig" target="_top">lots of sample applications</a> which demonstrate the use of Spring Security Java Configuration.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="hello-web-security-java-configuration" href="#hello-web-security-java-configuration"></a>5.1&nbsp;Hello Web Security Java Configuration</h2></div></div></div>

<p>The first step is to create our Spring Security Java Configuration. The configuration creates a Servlet Filter known as the <code class="literal">springSecurityFilterChain</code> which is responsible for all the security (protecting the application URLs, validating submitted username and passwords, redirecting to the log in form, etc) within your application. You can find the most basic example of a Spring Security Java Configuration below:</p>
<a name="jc-hello-wsca" href="#jc-hello-wsca"></a><pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;

<span class="hl-keyword">import</span> org.springframework.context.annotation.*;
<span class="hl-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.*;
<span class="hl-keyword">import</span> org.springframework.security.config.annotation.web.configuration.*;

<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
		InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
		manager.createUser(User.withUsername(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
		<span class="hl-keyword">return</span> manager;
	}
}</pre>
<p>There really isn&#8217;t much to this configuration, but it does a lot. You can find a summary of the features below:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Require authentication to every URL in your application
</li><li class="listitem">
Generate a login form for you
</li><li class="listitem">
Allow the user with the <span class="strong"><strong>Username</strong></span> <span class="emphasis"><em>user</em></span> and the <span class="strong"><strong>Password</strong></span> <span class="emphasis"><em>password</em></span> to authenticate with form based authentication
</li><li class="listitem">
Allow the user to logout
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_top">CSRF attack</a> prevention
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Session_fixation" target="_top">Session Fixation</a> protection
</li><li class="listitem">
<p class="simpara">Security Header integration</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security" target="_top">HTTP Strict Transport Security</a> for secure requests
</li><li class="listitem">
<a class="ulink" href="http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx" target="_top">X-Content-Type-Options</a> integration
</li><li class="listitem">
Cache Control (can be overridden later by your application to allow caching of your static resources)
</li><li class="listitem">
<a class="ulink" href="http://msdn.microsoft.com/en-us/library/dd565647(v=vs.85).aspx" target="_top">X-XSS-Protection</a> integration
</li><li class="listitem">
X-Frame-Options integration to help prevent <a class="ulink" href="http://en.wikipedia.org/wiki/Clickjacking" target="_top">Clickjacking</a>
</li></ul></div>
</li><li class="listitem">
<p class="simpara">Integrate with the following Servlet API methods</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getRemoteUser()" target="_top">HttpServletRequest#getRemoteUser()</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getUserPrincipal()" target="_top">HttpServletRequest.html#getUserPrincipal()</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#isUserInRole(java.lang.String)" target="_top">HttpServletRequest.html#isUserInRole(java.lang.String)</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#login(java.lang.String,%20java.lang.String)" target="_top">HttpServletRequest.html#login(java.lang.String, java.lang.String)</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#logout()" target="_top">HttpServletRequest.html#logout()</a>
</li></ul></div>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer" href="#abstractsecuritywebapplicationinitializer"></a>5.1.1&nbsp;AbstractSecurityWebApplicationInitializer</h3></div></div></div>

<p>The next step is to register the <code class="literal">springSecurityFilterChain</code> with the war. This can be done in Java Configuration with <a class="ulink" href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-container-config" target="_top">Spring&#8217;s WebApplicationInitializer support</a> in a Servlet 3.0+ environment. Not suprisingly, Spring Security provides a base class <code class="literal">AbstractSecurityWebApplicationInitializer</code> that will ensure the <code class="literal">springSecurityFilterChain</code> gets registered for you. The way in which we use <code class="literal">AbstractSecurityWebApplicationInitializer</code> differs depending on if we are already using Spring or if Spring Security is the only Spring component in our application.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="jc.html#abstractsecuritywebapplicationinitializer-without-existing-spring" title="5.1.2&nbsp;AbstractSecurityWebApplicationInitializer without Existing Spring">Section&nbsp;5.1.2, &#8220;AbstractSecurityWebApplicationInitializer without Existing Spring&#8221;</a> - Use these instructions if you are not using Spring already
</li><li class="listitem">
<a class="xref" href="jc.html#abstractsecuritywebapplicationinitializer-with-spring-mvc" title="5.1.3&nbsp;AbstractSecurityWebApplicationInitializer with Spring MVC">Section&nbsp;5.1.3, &#8220;AbstractSecurityWebApplicationInitializer with Spring MVC&#8221;</a> - Use these instructions if you are already using Spring
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer-without-existing-spring" href="#abstractsecuritywebapplicationinitializer-without-existing-spring"></a>5.1.2&nbsp;AbstractSecurityWebApplicationInitializer without Existing Spring</h3></div></div></div>

<p>If you are not using Spring or Spring MVC, you will need to pass in the <code class="literal">WebSecurityConfig</code> into the superclass to ensure the configuration is picked up. You can find an example below:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.web.context.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityWebApplicationInitializer
	<span class="hl-keyword">extends</span> AbstractSecurityWebApplicationInitializer {

	<span class="hl-keyword">public</span> SecurityWebApplicationInitializer() {
		<span class="hl-keyword">super</span>(WebSecurityConfig.<span class="hl-keyword">class</span>);
	}
}</pre>
<p>The <code class="literal">SecurityWebApplicationInitializer</code> will do the following things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Automatically register the springSecurityFilterChain Filter for every URL in your application
</li><li class="listitem">
Add a ContextLoaderListener that loads the <a class="link" href="jc.html#jc-hello-wsca">WebSecurityConfig</a>.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer-with-spring-mvc" href="#abstractsecuritywebapplicationinitializer-with-spring-mvc"></a>5.1.3&nbsp;AbstractSecurityWebApplicationInitializer with Spring MVC</h3></div></div></div>

<p>If we were using Spring elsewhere in our application we probably already had a <code class="literal">WebApplicationInitializer</code> that is loading our Spring Configuration. If we use the previous configuration we would get an error. Instead, we should register Spring Security with the existing <code class="literal">ApplicationContext</code>. For example, if we were using Spring MVC our <code class="literal">SecurityWebApplicationInitializer</code> would look something like the following:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.web.context.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityWebApplicationInitializer
	<span class="hl-keyword">extends</span> AbstractSecurityWebApplicationInitializer {

}</pre>
<p>This would simply only register the springSecurityFilterChain Filter for every URL in your application. After that we would ensure that <code class="literal">WebSecurityConfig</code> was loaded in our existing ApplicationInitializer. For example, if we were using Spring MVC it would be added in the <code class="literal">getRootConfigClasses()</code></p>
<a name="message-web-application-inititializer-java" href="#message-web-application-inititializer-java"></a><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MvcWebApplicationInitializer <span class="hl-keyword">extends</span>
		AbstractAnnotationConfigDispatcherServletInitializer {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Class[] { WebSecurityConfig.<span class="hl-keyword">class</span> };
	}

	<span class="hl-comment">// ... other overrides ...</span>
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-httpsecurity" href="#jc-httpsecurity"></a>5.2&nbsp;HttpSecurity</h2></div></div></div>

<p>Thus far our <a class="link" href="jc.html#jc-hello-wsca">WebSecurityConfig</a> only contains information about how to authenticate our users. How does Spring Security know that we want to require all users to be authenticated? How does Spring Security know we want to support form based authentication? The reason for this is that the <code class="literal">WebSecurityConfigurerAdapter</code> provides a default configuration in the <code class="literal">configure(HttpSecurity http)</code> method that looks like:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.and()
		.formLogin()
			.and()
		.httpBasic();
}</pre>
<p>The default configuration above:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Ensures that any request to our application requires the user to be authenticated
</li><li class="listitem">
Allows users to authenticate with form based login
</li><li class="listitem">
Allows users to authenticate with HTTP Basic authentication
</li></ul></div>
<p>You will notice that this configuration is quite similar the XML Namespace configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"authenticated"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;form-login /&gt;</span>
	<span class="hl-tag">&lt;http-basic /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The Java Configuration equivalent of closing an XML tag is expressed using the <code class="literal">and()</code> method which allows us to continue configuring the parent. If you read the code it also makes sense. I want to configure authorized requests <span class="emphasis"><em>and</em></span> configure form login <span class="emphasis"><em>and</em></span> configure HTTP Basic authentication.</p>
<p>However, Java Configuration has different defaults URLs and parameters. Keep this in mind when creating custom login pages. The result is that our URLs are more RESTful. Additionally, it is not quite so obvious we are using Spring Security which helps to prevent <a class="ulink" href="https://www.owasp.org/index.php/Information_Leak_(information_disclosure)" target="_top">information leaks</a>. For example:</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-form" href="#jc-form"></a>5.3&nbsp;Java Configuration and Form Login</h2></div></div></div>

<p>You might be wondering where the login form came from when you were prompted to log in, since we made no mention of any HTML files or JSPs. Since Spring Security&#8217;s default configuration does not explicitly set a URL for the login page, Spring Security generates one automatically, based on the features that are enabled and using standard values for the URL which processes the submitted login, the default target URL the user will be sent to after logging in and so on.</p>
<p>While the automatically generated log in page is convenient to get up and running quickly, most applications will want to provide their own log in page. To do so we can update our configuration as seen below:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.and()
		.formLogin()
			.loginPage(<span class="hl-string">"/login"</span>) <a name="CO1-1" href="#CO1-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.permitAll();        <a name="CO1-2" href="#CO1-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The updated configuration specifies the location of the log in page.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We must grant all users (i.e. unauthenticated users) access to our log in page. The <code class="literal">formLogin().permitAll()</code> method allows granting access to all users for all URLs associated with form based log in.</p>
</td></tr></table></div>
<p>An example log in page implemented with JSPs for our current configuration can be seen below:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The login page below represents our current configuration. We could easily update our configuration if some of the defaults do not meet our needs.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;c:url</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/login"</span> <span class="hl-attribute">var</span>=<span class="hl-value">"loginUrl"</span><span class="hl-tag">/&gt;</span>
&lt;form <span class="hl-attribute">action</span>=<span class="hl-value">"${loginUrl}"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span>&gt;       <a name="CO2-1" href="#CO2-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	<span class="hl-tag">&lt;c:if</span> <span class="hl-attribute">test</span>=<span class="hl-value">"${param.error != null}"</span><span class="hl-tag">&gt;</span>        <a name="CO2-2" href="#CO2-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		&lt;p&gt;
			Invalid username and password.
		&lt;/p&gt;
	<span class="hl-tag">&lt;/c:if&gt;</span>
	<span class="hl-tag">&lt;c:if</span> <span class="hl-attribute">test</span>=<span class="hl-value">"${param.logout != null}"</span><span class="hl-tag">&gt;</span>       <a name="CO2-3" href="#CO2-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		&lt;p&gt;
			You have been logged out.
		&lt;/p&gt;
	<span class="hl-tag">&lt;/c:if&gt;</span>
	&lt;p&gt;
		&lt;label <span class="hl-attribute">for</span>=<span class="hl-value">"username"</span>&gt;Username&lt;/label&gt;
		&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span>/&gt;	<a name="CO2-4" href="#CO2-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	&lt;/p&gt;
	&lt;p&gt;
		&lt;label <span class="hl-attribute">for</span>=<span class="hl-value">"password"</span>&gt;Password&lt;/label&gt;
		&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span>/&gt;	<a name="CO2-5" href="#CO2-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	&lt;/p&gt;
	&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>                        <a name="CO2-6" href="#CO2-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		name="${_csrf.parameterName}"
		value="${_csrf.token}"/&gt;
	&lt;button <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn"</span>&gt;Log in&lt;/button&gt;
&lt;/form&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A POST to the <code class="literal">/login</code> URL will attempt to authenticate the user</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the query parameter <code class="literal">error</code> exists, authentication was attempted and failed</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the query parameter <code class="literal">logout</code> exists, the user was successfully logged out</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The username must be present as the HTTP parameter named <span class="emphasis"><em>username</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The password must be present as the HTTP parameter named <span class="emphasis"><em>password</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We must <a class="xref" href="csrf.html#csrf-include-csrf-token" title="18.4.3&nbsp;Include the CSRF Token">Section&nbsp;18.4.3, &#8220;Include the CSRF Token&#8221;</a> To learn more read the <a class="xref" href="csrf.html" title="18.&nbsp;Cross Site Request Forgery (CSRF)">Chapter&nbsp;18, <i>Cross Site Request Forgery (CSRF)</i></a> section of the reference</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authorize-requests" href="#authorize-requests"></a>5.4&nbsp;Authorize Requests</h2></div></div></div>

<p>Our examples have only required users to be authenticated and have done so for every URL in our application. We can specify custom requirements for our URLs by adding multiple children to our <code class="literal">http.authorizeRequests()</code> method. For example:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()                                                                <a name="CO3-1" href="#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.antMatchers(<span class="hl-string">"/resources/**"</span>, <span class="hl-string">"/signup"</span>, <span class="hl-string">"/about"</span>).permitAll()                  <a name="CO3-2" href="#CO3-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
			.antMatchers(<span class="hl-string">"/admin/**"</span>).hasRole(<span class="hl-string">"ADMIN"</span>)                                      <a name="CO3-3" href="#CO3-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
			.antMatchers(<span class="hl-string">"/db/**"</span>).access(<span class="hl-string">"hasRole('ADMIN') and hasRole('DBA')"</span>)            <a name="CO3-4" href="#CO3-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
			.anyRequest().authenticated()                                                   <a name="CO3-5" href="#CO3-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
			.and()
		<span class="hl-comment">// ...</span>
		.formLogin();
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>There are multiple children to the <code class="literal">http.authorizeRequests()</code> method each matcher is considered in the order they were declared.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We specified multiple URL patterns that any user can access. Specifically, any user can access a request if the URL starts with "/resources/", equals "/signup", or equals "/about".</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that starts with "/admin/" will be restricted to users who have the role "ROLE_ADMIN". You will notice that since we are invoking the <code class="literal">hasRole</code> method we do not need to specify the "ROLE_" prefix.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that starts with "/db/" requires the user to have both "ROLE_ADMIN" and "ROLE_DBA". You will notice that since we are using the <code class="literal">hasRole</code> expression we do not need to specify the "ROLE_" prefix.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that has not already been matched on only requires that the user be authenticated</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-logout" href="#jc-logout"></a>5.5&nbsp;Handling Logouts</h2></div></div></div>

<p>When using the <code class="literal"><a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" target="_top">WebSecurityConfigurerAdapter</a></code>, logout capabilities are automatically applied. The default is that accessing the URL <code class="literal">/logout</code> will log the user out by:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Invalidating the HTTP Session
</li><li class="listitem">
Cleaning up any RememberMe authentication that was configured
</li><li class="listitem">
Clearing the <code class="literal">SecurityContextHolder</code>
</li><li class="listitem">
Redirect to <code class="literal">/login?logout</code>
</li></ul></div>
<p>Similar to configuring login capabilities, however, you also have various options to further customize your logout requirements:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.logout()                                                                <a name="CO4-1" href="#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.logoutUrl(<span class="hl-string">"/my/logout"</span>)                                                 <a name="CO4-2" href="#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
			.logoutSuccessUrl(<span class="hl-string">"/my/index"</span>)                                           <a name="CO4-3" href="#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
			.logoutSuccessHandler(logoutSuccessHandler)                              <a name="CO4-4" href="#CO4-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
			.invalidateHttpSession(true)                                             <a name="CO4-5" href="#CO4-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
			.addLogoutHandler(logoutHandler)                                         <a name="CO4-6" href="#CO4-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
			.deleteCookies(cookieNamesToClear)                                       <a name="CO4-7" href="#CO4-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
			.and()
		...
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides logout support. This is automatically applied when using <code class="literal">WebSecurityConfigurerAdapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The URL that triggers log out to occur (default is <code class="literal">/logout</code>). If CSRF protection is enabled (default), then the request must also be a POST. For more information, please consult the <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutUrl-java.lang.String-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The URL to redirect to after logout has occurred. The default is <code class="literal">/login?logout</code>. For more information, please consult the <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutSuccessUrl-java.lang.String-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Let&#8217;s you specify a custom <code class="literal">LogoutSuccessHandler</code>. If this is specified, <code class="literal">logoutSuccessUrl()</code> is ignored. For more information, please consult the <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutSuccessHandler-org.springframework.security.web.authentication.logout.LogoutSuccessHandler-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether to invalidate the <code class="literal">HttpSession</code> at the time of logout. This is <span class="strong"><strong>true</strong></span> by default. Configures the <code class="literal">SecurityContextLogoutHandler</code> under the covers. For more information, please consult the <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#invalidateHttpSession-boolean-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Adds a <code class="literal">LogoutHandler</code>. <code class="literal">SecurityContextLogoutHandler</code> is added as the last <code class="literal">LogoutHandler</code> by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows specifying the names of cookies to be removed on logout success. This is a shortcut for adding a <code class="literal">CookieClearingLogoutHandler</code> explicitly.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Logouts can of course also be configured using the XML Namespace notation. Please see the documentation for the <a class="link" href="appendix-namespace.html#nsa-logout" title="41.1.26&nbsp;<logout&gt;">logout element</a> in the Spring Security XML Namespace section for further details.</p>
</td></tr></table></div>
<p>Generally, in order to customize logout functionality, you can add
<code class="literal"><a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutHandler.html" target="_top">LogoutHandler</a></code>
and/or
<code class="literal"><a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutSuccessHandler.html" target="_top">LogoutSuccessHandler</a></code>
implementations. For many common scenarios, these handlers are applied under the
covers when using the fluent API.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-handler" href="#jc-logout-handler"></a>5.5.1&nbsp;LogoutHandler</h3></div></div></div>

<p>Generally, <code class="literal"><a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutHandler.html" target="_top">LogoutHandler</a></code>
implementations indicate classes that are able to participate in logout handling.
They are expected to be invoked to perform necessary clean-up. As such they should
not throw exceptions. Various implementations are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/rememberme/PersistentTokenBasedRememberMeServices.html" target="_top">PersistentTokenBasedRememberMeServices</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/rememberme/TokenBasedRememberMeServices.html" target="_top">TokenBasedRememberMeServices</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/CookieClearingLogoutHandler.html" target="_top">CookieClearingLogoutHandler</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/csrf/CsrfLogoutHandler.html" target="_top">CsrfLogoutHandler</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/SecurityContextLogoutHandler.html" target="_top">SecurityContextLogoutHandler</a>
</li></ul></div>
<p>Please see <a class="xref" href="remember-me.html#remember-me-impls" title="17.4&nbsp;Remember-Me Interfaces and Implementations">Section&nbsp;17.4, &#8220;Remember-Me Interfaces and Implementations&#8221;</a> for details.</p>
<p>Instead of providing <code class="literal">LogoutHandler</code> implementations directly, the fluent API
also provides shortcuts that provide the respective <code class="literal">LogoutHandler</code> implementations
under the covers. E.g. <code class="literal">deleteCookies()</code> allows specifying the names of one or
more cookies to be removed on logout success. This is a shortcut compared to adding a
<code class="literal">CookieClearingLogoutHandler</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-success-handler" href="#jc-logout-success-handler"></a>5.5.2&nbsp;LogoutSuccessHandler</h3></div></div></div>

<p>The <code class="literal">LogoutSuccessHandler</code> is called after a successful logout by the <code class="literal">LogoutFilter</code>,
to handle e.g. redirection or forwarding to the appropriate destination. Note that the
interface is almost the same as the <code class="literal">LogoutHandler</code> but may raise an exception.</p>
<p>The following implementations are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/SimpleUrlLogoutSuccessHandler.html" target="_top">SimpleUrlLogoutSuccessHandler</a>
</li><li class="listitem">
HttpStatusReturningLogoutSuccessHandler
</li></ul></div>
<p>As mentioned above, you don&#8217;t need to specify the <code class="literal">SimpleUrlLogoutSuccessHandler</code> directly.
Instead, the fluent API provides a shortcut by setting the <code class="literal">logoutSuccessUrl()</code>.
This will setup the <code class="literal">SimpleUrlLogoutSuccessHandler</code> under the covers. The provided URL will
be redirected to after a logout has occurred. The default is <code class="literal">/login?logout</code>.</p>
<p>The <code class="literal">HttpStatusReturningLogoutSuccessHandler</code> can be interesting in REST API type
scenarios. Instead of redirecting to a URL upon the successful logout, this <code class="literal">LogoutSuccessHandler</code>
allows you to provide a plain HTTP status code to be returned. If not configured
a status code 200 will be returned by default.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-references" href="#jc-logout-references"></a>5.5.3&nbsp;Further Logout-Related References</h3></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="ns-config.html#ns-logout" title="6.2.4&nbsp;Logout Handling">Logout Handling</a>
</li><li class="listitem">
<a class="link" href="test-mockmvc.html#test-logout" title="12.3.2&nbsp;Testing Logout">Testing Logout</a>
</li><li class="listitem">
<a class="link" href="servletapi.html#servletapi-logout" title="15.2.3&nbsp;HttpServletRequest.logout()">HttpServletRequest.logout()</a>
</li><li class="listitem">
<a class="xref" href="remember-me.html#remember-me-impls" title="17.4&nbsp;Remember-Me Interfaces and Implementations">Section&nbsp;17.4, &#8220;Remember-Me Interfaces and Implementations&#8221;</a>
</li><li class="listitem">
<a class="link" href="csrf.html#csrf-logout" title="18.5.3&nbsp;Logging Out">Logging Out</a> in section CSRF Caveats
</li><li class="listitem">
Section <a class="link" href="cas.html#cas-singlelogout" title="32.3.2&nbsp;Single Logout">Single Logout</a> (CAS protocol)
</li><li class="listitem">
Documentation for the <a class="link" href="appendix-namespace.html#nsa-logout" title="41.1.26&nbsp;<logout&gt;">logout element</a> in the Spring Security XML Namespace section
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-authentication" href="#jc-authentication"></a>5.6&nbsp;Authentication</h2></div></div></div>

<p>Thus far we have only taken a look at the most basic authentication configuration. Let&#8217;s take a look at a few slightly more advanced options for configuring authentication.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-inmemory" href="#jc-authentication-inmemory"></a>5.6.1&nbsp;In-Memory Authentication</h3></div></div></div>

<p>We have already seen an example of configuring in-memory authentication for a single user. Below is an example to configure multiple users:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
	InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
	manager.createUser(User.withUsername(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
	manager.createUser(User.withUsername(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build());
	<span class="hl-keyword">return</span> manager;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-jdbc" href="#jc-authentication-jdbc"></a>5.6.2&nbsp;JDBC Authentication</h3></div></div></div>

<p>You can find the updates to support JDBC based authentication. The example below assumes that you have already defined a <code class="literal">DataSource</code> within your application. The <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig/jdbc" target="_top">jdbc-javaconfig</a> sample provides a complete example of using JDBC based authentication.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> DataSource dataSource;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span class="hl-keyword">throws</span> Exception {
	auth
		.jdbcAuthentication()
			.dataSource(dataSource)
			.withDefaultSchema()
			.withUser(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).and()
			.withUser(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>, <span class="hl-string">"ADMIN"</span>);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-authentication" href="#ldap-authentication"></a>5.6.3&nbsp;LDAP Authentication</h3></div></div></div>

<p>You can find the updates to support LDAP based authentication. The <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig/ldap" target="_top">ldap-javaconfig</a> sample provides a complete example of using LDAP based authentication.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> DataSource dataSource;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span class="hl-keyword">throws</span> Exception {
	auth
		.ldapAuthentication()
			.userDnPatterns(<span class="hl-string">"uid={0},ou=people"</span>)
			.groupSearchBase(<span class="hl-string">"ou=groups"</span>);
}</pre>
<p>The example above uses the following LDIF and an embedded Apache DS LDAP instance.</p>
<p>
<b>users.ldif.&nbsp;</b>

</p><pre class="screen">dn: ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: organizationalUnit
ou: groups

dn: ou=people,dc=springframework,dc=org
objectclass: top
objectclass: organizationalUnit
ou: people

dn: uid=admin,ou=people,dc=springframework,dc=org
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
cn: Rod Johnson
sn: Johnson
uid: admin
userPassword: password

dn: uid=user,ou=people,dc=springframework,dc=org
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
cn: Dianne Emu
sn: Emu
uid: user
userPassword: password

dn: cn=user,ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: groupOfNames
cn: user
uniqueMember: uid=admin,ou=people,dc=springframework,dc=org
uniqueMember: uid=user,ou=people,dc=springframework,dc=org

dn: cn=admin,ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: groupOfNames
cn: admin
uniqueMember: uid=admin,ou=people,dc=springframework,dc=org</pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-authenticationprovider" href="#jc-authentication-authenticationprovider"></a>5.6.4&nbsp;AuthenticationProvider</h3></div></div></div>

<p>You can define custom authentication by exposing a custom <code class="literal">AuthenticationProvider</code> as a bean.
For example, the following will customize authentication assuming that <code class="literal">SpringAuthenticationProvider</code> implements <code class="literal">AuthenticationProvider</code>:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is only used if the <code class="literal">AuthenticationManagerBuilder</code> has not been populated</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpringAuthenticationProvider springAuthenticationProvider() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpringAuthenticationProvider();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-userdetailsservice" href="#jc-authentication-userdetailsservice"></a>5.6.5&nbsp;UserDetailsService</h3></div></div></div>

<p>You can define custom authentication by exposing a custom <code class="literal">UserDetailsService</code> as a bean.
For example, the following will customize authentication assuming that <code class="literal">SpringDataUserDetailsService</code> implements <code class="literal">UserDetailsService</code>:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is only used if the <code class="literal">AuthenticationManagerBuilder</code> has not been populated and no <code class="literal">AuthenticationProviderBean</code> is defined.</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpringDataUserDetailsService springDataUserDetailsService() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpringDataUserDetailsService();
}</pre>
<p>You can also customize how passwords are encoded by exposing a <code class="literal">PasswordEncoder</code> as a bean.
For example, if you use bcrypt you can add a bean definition as shown below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> BCryptPasswordEncoder passwordEncoder() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> BCryptPasswordEncoder();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-authentication-2" href="#ldap-authentication-2"></a>5.6.6&nbsp;LDAP Authentication</h3></div></div></div>


</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multiple-httpsecurity" href="#multiple-httpsecurity"></a>5.7&nbsp;Multiple HttpSecurity</h2></div></div></div>

<p>We can configure multiple HttpSecurity instances just as we can have multiple <code class="literal">&lt;http&gt;</code> blocks. The key is to extend the <code class="literal">WebSecurityConfigurerAdapter</code> multiple times. For example, the following is an example of having a different configuration for URL&#8217;s that start with <code class="literal">/api/</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MultiHttpSecurityConfig {
	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
		InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
		manager.createUser(User.withUsername(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
		manager.createUser(User.withUsername(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build());
		<span class="hl-keyword">return</span> manager;
	}

	<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
	<em><span class="hl-annotation" style="color: gray">@Order(1)</span></em>                                                        <a name="CO5-1" href="#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> ApiWebSecurityConfigurationAdapter <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.antMatcher(<span class="hl-string">"/api/**"</span>)                               <a name="CO5-2" href="#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
				.authorizeRequests()
					.anyRequest().hasRole(<span class="hl-string">"ADMIN"</span>)
					.and()
				.httpBasic();
		}
	}

	<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>                                                   <a name="CO5-3" href="#CO5-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> FormLoginWebSecurityConfigurerAdapter <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.authorizeRequests()
					.anyRequest().authenticated()
					.and()
				.formLogin();
		}
	}
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p></p></td><td valign="top" align="left">
<p>Configure Authentication as normal</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Create an instance of <code class="literal">WebSecurityConfigurerAdapter</code> that contains <code class="literal">@Order</code> to specify which <code class="literal">WebSecurityConfigurerAdapter</code> should be considered first.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">http.antMatcher</code> states that this <code class="literal">HttpSecurity</code> will only be applicable to URLs that start with <code class="literal">/api/</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Create another instance of <code class="literal">WebSecurityConfigurerAdapter</code>. If the URL does not start with <code class="literal">/api/</code> this configuration will be used. This configuration is considered after <code class="literal">ApiWebSecurityConfigurationAdapter</code> since it has an <code class="literal">@Order</code> value after <code class="literal">1</code> (no <code class="literal">@Order</code> defaults to last).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-method" href="#jc-method"></a>5.8&nbsp;Method Security</h2></div></div></div>

<p>From version 2.0 onwards Spring Security has improved support substantially for adding security to your service layer methods. It provides support for JSR-250 annotation security as well as the framework&#8217;s original <code class="literal">@Secured</code> annotation. From 3.0 you can also make use of new <a class="link" href="el-access.html" title="26.&nbsp;Expression-Based Access Control">expression-based annotations</a>. You can apply security to a single bean, using the <code class="literal">intercept-methods</code> element to decorate the bean declaration, or you can secure multiple beans across the entire service layer using the AspectJ style pointcuts.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="enableglobalmethodsecurity" href="#enableglobalmethodsecurity"></a>5.8.1&nbsp;EnableGlobalMethodSecurity</h3></div></div></div>

<p>We can enable annotation-based security using the <code class="literal">@EnableGlobalMethodSecurity</code> annotation on any <code class="literal">@Configuration</code> instance. For example, the following would enable Spring Security&#8217;s <code class="literal">@Secured</code> annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(securedEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>Adding an annotation to a method (on a class or interface) would then limit the access to that method accordingly. Spring Security&#8217;s native annotation support defines a set of attributes for the method. These will be passed to the AccessDecisionManager for it to make the actual decision:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@Secured("ROLE_TELLER")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
<p>Support for JSR-250 annotations can be enabled using</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(jsr250Enabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>These are standards-based and allow simple role-based constraints to be applied but do not have the power Spring Security&#8217;s native annotations. To use the new expression-based syntax, you would use</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>and the equivalent Java code would be</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasAuthority('ROLE_TELLER')")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="globalmethodsecurityconfiguration" href="#globalmethodsecurityconfiguration"></a>5.8.2&nbsp;GlobalMethodSecurityConfiguration</h3></div></div></div>

<p>Sometimes you may need to perform operations that are more complicated than are possible with the <code class="literal">@EnableGlobalMethodSecurity</code> annotation allow. For these instances, you can extend the <code class="literal">GlobalMethodSecurityConfiguration</code> ensuring that the <code class="literal">@EnableGlobalMethodSecurity</code> annotation is present on your subclass. For example, if you wanted to provide a custom <code class="literal">MethodSecurityExpressionHandler</code>, you could use the following configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig <span class="hl-keyword">extends</span> GlobalMethodSecurityConfiguration {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> MethodSecurityExpressionHandler createExpressionHandler() {
		<span class="hl-comment">// ... create and return custom MethodSecurityExpressionHandler ...</span>
		<span class="hl-keyword">return</span> expressionHandler;
	}
}</pre>
<p>For additional information about methods that can be overridden, refer to the <code class="literal">GlobalMethodSecurityConfiguration</code> Javadoc.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="post-processing-configured-objects" href="#post-processing-configured-objects"></a>5.9&nbsp;Post Processing Configured Objects</h2></div></div></div>

<p>Spring Security&#8217;s Java Configuration does not expose every property of every object that it configures. This simplifies the configuration for a majority of users. Afterall, if every property was exposed, users could use standard bean configuration.</p>
<p>While there are good reasons to not directly expose every property, users may still need more advanced configuration options. To address this Spring Security introduces the concept of an <code class="literal">ObjectPostProcessor</code> which can be used to modify or replace many of the Object instances created by the Java Configuration. For example, if you wanted to configure the <code class="literal">filterSecurityPublishAuthorizationSuccess</code> property on <code class="literal">FilterSecurityInterceptor</code> you could use the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.withObjectPostProcessor(<span class="hl-keyword">new</span> ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() {
				<span class="hl-keyword">public</span> &lt;O <span class="hl-keyword">extends</span> FilterSecurityInterceptor&gt; O postProcess(
						O fsi) {
					fsi.setPublishAuthorizationSuccess(true);
					<span class="hl-keyword">return</span> fsi;
				}
			});
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-custom-dsls" href="#jc-custom-dsls"></a>5.10&nbsp;Custom DSLs</h2></div></div></div>

<p>You can provide your own custom DSLs in Spring Security.
For example, you might have something that looks like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyCustomDsl <span class="hl-keyword">extends</span> AbstractHttpConfigurer&lt;CorsConfigurerMyCustomDsl, HttpSecurity&gt; {
	<span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> flag;

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init(H http) <span class="hl-keyword">throws</span> Exception {
		<span class="hl-comment">// any method that adds another configurer</span>
		<span class="hl-comment">// must be done in the init method</span>
		http.csrf().disable();
	}

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configure(H http) <span class="hl-keyword">throws</span> Exception {
		ApplicationContext context = http.getSharedObject(ApplicationContext.<span class="hl-keyword">class</span>);

		<span class="hl-comment">// here we lookup from the ApplicationContext. You can also just create a new instance.</span>
		MyFilter myFilter = context.getBean(MyFilter.<span class="hl-keyword">class</span>);
		myFilter.setFlag(flag);
		http.addFilterBefore(myFilter, UsernamePasswordAuthenticationFilter.<span class="hl-keyword">class</span>);
	}

	<span class="hl-keyword">public</span> MyCustomDsl flag(<span class="hl-keyword">boolean</span> value) {
		<span class="hl-keyword">this</span>.flag = value;
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> MyCustomDsl customDsl() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MyCustomDsl();
	}
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is actually how methods like <code class="literal">HttpSecurity.authorizeRequests()</code> are implemented.</p>
</td></tr></table></div>
<p>The custom DSL can then be used like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.apply(customDsl())
				.flag(true)
				.and()
			...;
	}
}</pre>
<p>The code is invoked in the following order:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Code in `Config`s configure method is invoked
</li><li class="listitem">
Code in `MyCustomDsl`s init method is invoked
</li><li class="listitem">
Code in `MyCustomDsl`s configure method is invoked
</li></ul></div>
<p>If you want, you can have <code class="literal">WebSecurityConfiguerAdapter</code> add <code class="literal">MyCustomDsl</code> by default by using <code class="literal">SpringFactories</code>.
For example, you would create a resource on the classpath named <code class="literal">META-INF/spring.factories</code> with the following contents:</p>
<p>
<b>META-INF/spring.factories.&nbsp;</b>

</p><pre class="screen">org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer = sample.MyCustomDsl</pre><p>

</p>
<p>Users wishing to disable the default can do so explicitly.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.apply(customDsl()).disable()
			...;
	}
}</pre>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="samples.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="preface.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ns-config.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">4.&nbsp;Samples and Guides (Start Here)&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;6.&nbsp;Security Namespace Configuration</td></tr></table></div></body></html>